/*----------------------------------------------------------------------* 
 * Copyright  (c) 2014 SAP SE. All rights reserved	
 * Author       : SAP Custom Development 
 *----------------------------------------------------------------------*/ 
	!function(){"use strict";jQuery.sap.require({modName:"com.zespri.awct.core.Controller",type:"controller"}),jQuery.sap.require("com.zespri.awct.control.SearchHelpInput"),jQuery.sap.require("com.zespri.awct.util.Enums"),jQuery.sap.require("com.zespri.awct.util.I18NHelper"),jQuery.sap.require("com.zespri.awct.util.LocaleFormatHelper"),jQuery.sap.require("com.zespri.awct.util.ModelHelper"),jQuery.sap.require("com.zespri.awct.util.NotificationHelper"),com.zespri.awct.core.Controller.extend("com.zespri.awct.collab.view.TrackOrdersSearchForm",{_DeliveryStatus:{BeforeRelease:"B4REL",DeliveryRelease:"REL",DeliveryLock:"LOCK",DeliveryUnlock:"UNLCK",ChangesDuringLock:"COLK",OnUnlockDIFOTIS:"COULK"},onInit:function(){this._oSearchHelpDialog=null,this._bUserAuthorized=!1,this._aSearchInputIDs=["seasonInput","shipmentNumberInput","deliveryNumberInput","containerIDInput","lineNumberInput","supplierInput","fromDateInput","toDateInput","userInput","brandInput","varietyInput","classInput","growingMethodInput","palletInput","deliveryStatusInput","exemptionStatusInput","stackInput","packStyleInput","sizeInput","labelInput"];var a=this;this.getRouter().attachRoutePatternMatched(function(b){return"Collaboration/TrackOrdersSearchForm"!==b.getParameter("name")||a._bUserAuthorized?void 0:void com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_USER_NOT_AUTHORIZED_MESSAGE_TEXT"))})},onBeforeRendering:function(){com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Display,com.zespri.awct.util.Enums.AuthorizationObject.Collaboration,com.zespri.awct.util.Enums.AuthorizationFunctions.ZSUP)||com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Display,com.zespri.awct.util.Enums.AuthorizationObject.Collaboration,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)?(this._bUserAuthorized=!0,this._setCurrentSeasonSelected()):(this.byId("pageOrderHistorySearchForm")&&this.byId("pageOrderHistorySearchForm").destroy(),this._bUserAuthorized=!1)},_getCustomDataForKey:function(a,b){var c=a.getCustomData();if(c.length)for(var d=0;d<c.length;d++)if(c[d].getKey()===b)return c[d];return""},_getFilterString:function(){var a=this,b=this.getView(),c=[];return jQuery.each(this._aSearchInputIDs,function(d,e){var f=b.byId(e);if(f.getValue()){var g;switch(a._getCustomDataForKey(f,"label").getValue()){case"From Date":g=com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_ORDERHISTORY_TOOLBAR_FROM_DATE_TEXT")+" ("+f.getValue()+")";break;case"To Date":g=com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_ORDERHISTORY_TOOLBAR_TO_DATE_TEXT")+" ("+f.getValue()+")";break;default:g=a._getCustomDataForKey(f,"label").getValue()+" ("+f.getValue()+")"}c.push(g)}}),c.join(", ")},_getDownloadFilterString:function(){for(var a=0,b=[],c=this.getView().byId("fromDateInput"),d=this.getView().byId("toDateInput");a<this._aSearchInputIDs.length;){var e=this.getView().byId(this._aSearchInputIDs[a]),f=[],g="";if(this._getCustomDataForKey(e,"filterButtonKey")&&(g=this._getCustomDataForKey(e,"filterButtonKey").getValue()),this._getCustomDataForKey(e,"filterValue")){var h=this._getCustomDataForKey(e,"filterValue").getValue();for(var i in h){var j=g+" eq '"+h[i]+"'";f.push(j)}var k="("+f.join(" or ")+")";b.push(k)}a+=1}if(c.getValue()){var l="("+this._getCustomDataForKey(c,"filterButtonKey").getValue()+" eq "+this._getExternalFormatValue(c.getYyyymmdd(),!0)+")";b.push(l)}if(d.getValue()){var m="("+this._getCustomDataForKey(d,"filterButtonKey").getValue()+" eq "+this._getExternalFormatValue(d.getYyyymmdd(),!0)+")";b.push(m)}return b.join(" and ")},bindTableSelectDialog:function(a){var b=this.getView(),c=this,d=c._getCustomDataForKey(a,"entitySet").getValue(),e=c._getCustomDataForKey(a,"BindingKey").getValue(),f="",g="";c._getCustomDataForKey(a,"filter")&&(f=c._getCustomDataForKey(a,"filter").getValue());var h=function(b){c._oSearchHelpDialog.setGrowingThreshold(b.getData().results.length),c._oSearchHelpDialog.setModel(b);var d={path:"/results",factory:function(a,b){var c=b.getProperty(e);return new sap.m.ColumnListItem({cells:[new sap.m.Text({text:c})]})}};c._oSearchHelpDialog.bindItems(d);for(var f=a.getValue().split(", "),g=0;g<f.length;g++)for(var h=0;h<c._oSearchHelpDialog.getItems().length;h++)f[g]&&f[g]===c._oSearchHelpDialog.getItems()[h].getCells()[0].getText()&&c._oSearchHelpDialog.getItems()[h].setSelected(!0);c._oSearchHelpDialog._dialog.setBusy(!1)};this._oSearchHelpDialog.destroyItems(),this._oSearchHelpDialog._dialog.setBusy(!0),this._oSearchHelpDialog._dialog.setBusyIndicatorDelay(0);var i=c._getCustomDataForKey(a,"filterButtonKey").getValue();switch(i){case"ShipmentID":var j=b.byId("seasonInput"),k=[];c._getCustomDataForKey(j,"filterValue")&&(k=c._getCustomDataForKey(j,"filterValue").getValue());var l="Season eq '"+sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason+"'";if(1===k.length)l="Season eq '"+k[0]+"'";else if(k.length>1){for(var m=[],n=0;n<k.length;n++)m[n]="ShipmentID eq '"+k[n]+"'";l="("+m.join(" or ")+")"}com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$select:e,$filter:l}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()});break;case"DeliveryID":var o=b.byId("shipmentNumberInput"),p=[];c._getCustomDataForKey(o,"filterValue")&&(p=c._getCustomDataForKey(o,"filterValue").getValue());var q="";if(1===p.length)q="ShipmentID eq '"+p[0]+"'";else if(p.length>1){for(var r=[],s=0;s<p.length;s++)r[s]="ShipmentID eq '"+p[s]+"'";q="("+r.join(" or ")+")"}com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$select:e,$filter:q}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()});break;case"SupplierID":com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$filter:"UserID eq '"+c.getView().getModel("currentUserDetails").getProperty("/UserID")+"'"}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()});break;case"ContainerID":var t=b.byId("shipmentNumberInput"),u=[];if(c._getCustomDataForKey(t,"filterValue")&&(u=c._getCustomDataForKey(t,"filterValue").getValue()),c._getCustomDataForKey(t,"filterValue")){var v="";if(1===u.length)v="ShipmentID eq '"+u[0]+"'";else if(u.length>1){for(var w=[],x=0;x<u.length;x++)w.push("ShipmentID eq '"+u[x]+"'");v="("+w.join(" or ")+")"}g=v}com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$filter:g}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()});break;case"DeliveryLineNumber":var y=b.byId("deliveryNumberInput"),z=[];c._getCustomDataForKey(y,"filterValue")&&(z=c._getCustomDataForKey(y,"filterValue").getValue()),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/GetLineNumbersForDelivery",{urlParameters:{DeliveryID:"'"+z[0]+"'"}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()});break;default:if(g="",f){var A=JSON.parse(f);g=A.path+" "+A.operator+" '"+A.value1+"'"}com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$filter:g}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()})}},handleValueHelpExemptionStatusPress:function(a){this._oSearchInputField=a.getSource(),this._oSearchHelpDialog||(this._oSearchHelpDialog=new sap.ui.xmlfragment("trackOrdersSearchFormDialog","com.zespri.awct.collab.fragment.SearchFieldSelectionDialog",this),this.getView().addDependent(this._oSearchHelpDialog));var b=this._getCustomDataForKey(this._oSearchInputField,"label").getValue();this._oSearchHelpDialog.setTitle(b),sap.ui.core.Fragment.byId("trackOrdersSearchFormDialog","searchFieldLabel").setText(com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_HISTORY_SEARCH_FORM_VALUE_HELP_DIALOG_ALL_LABEL"));var c={ExemptionStatusSet:[{key:com.zespri.awct.util.Enums.ExemptionStatus.NONE,value:"NONE"},{key:com.zespri.awct.util.Enums.ExemptionStatus.PENDING,value:"PENDING"},{key:com.zespri.awct.util.Enums.ExemptionStatus.COMPLETE,value:"COMPLETE"}]},d=new sap.ui.model.json.JSONModel(c);this._oSearchHelpDialog.setModel(d,"ExemptionStatus");var e={path:"ExemptionStatus>/ExemptionStatusSet",factory:function(a,b){var c=b.getProperty("value");return new sap.m.ColumnListItem({cells:[new sap.m.Text({text:c})]})}};this._oSearchHelpDialog.bindItems(e);for(var f=this._oSearchInputField.getValue().split(", "),g=0;g<f.length;g++)for(var h=0;h<this._oSearchHelpDialog.getItems().length;h++)f[g]===this._oSearchHelpDialog.getItems()[h].getCells()[0].getText()&&this._oSearchHelpDialog.getItems()[h].setSelected(!0);this._oSearchHelpDialog.open()},handleValueHelpDeliveryStatusPress:function(a){this._oSearchInputField=a.getSource(),this._oSearchHelpDialog||(this._oSearchHelpDialog=new sap.ui.xmlfragment("trackOrdersSearchFormDialog","com.zespri.awct.collab.fragment.SearchFieldSelectionDialog",this),this.getView().addDependent(this._oSearchHelpDialog));var b=this._getCustomDataForKey(this._oSearchInputField,"label").getValue();this._oSearchHelpDialog.setTitle(b),sap.ui.core.Fragment.byId("trackOrdersSearchFormDialog","searchFieldLabel").setText(com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_HISTORY_SEARCH_FORM_VALUE_HELP_DIALOG_ALL_LABEL"));var c={DeliveryStatusSet:[{key:this._DeliveryStatus.BeforeRelease,value:com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_HISTORY_SEARCH_FORM_DELIVERY_STATUS_BEFORE_RELEASE_TEXT")},{key:this._DeliveryStatus.DeliveryRelease,value:com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_HISTORY_SEARCH_FORM_DELIVERY_STATUS_DELIVERY_RELEASE_TEXT")},{key:this._DeliveryStatus.DeliveryLock,value:com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_HISTORY_SEARCH_FORM_DELIVERY_STATUS_DELIVERY_LOCK_TEXT")},{key:this._DeliveryStatus.DeliveryUnock,value:com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_HISTORY_SEARCH_FORM_DELIVERY_STATUS_DELIVERY_UNLOCK_TEXT")},{key:this._DeliveryStatus.ChangesDuringLock,value:com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_HISTORY_SEARCH_FORM_DELIVERY_STATUS_CHANGES_DURING_LOCK_TEXT")},{key:this._DeliveryStatus.OnUnlockDIFOTIS,value:com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_HISTORY_SEARCH_FORM_DELIVERY_STATUS_ON_UNLOCK_TEXT")}]},d=new sap.ui.model.json.JSONModel(c);this._oSearchHelpDialog.setModel(d,"DeliveryStatus");var e={path:"DeliveryStatus>/DeliveryStatusSet",factory:function(a,b){var c=b.getProperty("value");return new sap.m.ColumnListItem({cells:[new sap.m.Text({text:c})]})}};this._oSearchHelpDialog.bindItems(e);for(var f=this._oSearchInputField.getValue().split(", "),g=0;g<f.length;g++)for(var h=0;h<this._oSearchHelpDialog.getItems().length;h++)f[g]===this._oSearchHelpDialog.getItems()[h].getCells()[0].getText()&&this._oSearchHelpDialog.getItems()[h].setSelected(!0);this._oSearchHelpDialog.open()},handleValueHelpPress:function(a){this._oSearchInputField=a.getSource(),this._oSearchHelpDialog||(this._oSearchHelpDialog=new sap.ui.xmlfragment("trackOrdersSearchFormDialog","com.zespri.awct.collab.fragment.SearchFieldSelectionDialog",this),this.getView().addDependent(this._oSearchHelpDialog));var b=this._getCustomDataForKey(this._oSearchInputField,"label").getValue();this._oSearchHelpDialog.setTitle(b),this._oSearchInputField.getId()===this.createId("deliveryNumberInput")?(this._oSearchHelpDialog.setMultiSelect(!1),sap.ui.core.Fragment.byId("trackOrdersSearchFormDialog","searchFieldLabel").setVisible(!1)):(this._oSearchHelpDialog.setMultiSelect(!0),sap.ui.core.Fragment.byId("trackOrdersSearchFormDialog","searchFieldLabel").setText(com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_HISTORY_SEARCH_FORM_VALUE_HELP_DIALOG_ALL_LABEL")),sap.ui.core.Fragment.byId("trackOrdersSearchFormDialog","searchFieldLabel").setVisible(!0)),com.zespri.awct.util.CommonHelper.manageNoDataText(this._oSearchHelpDialog._table),this.bindTableSelectDialog(this._oSearchInputField),this._oSearchHelpDialog.open()},handleValueHelpDialogSearch:function(a){var b=a.getParameter("value"),c=this.getView().getController()._getCustomDataForKey(this._oSearchInputField,"filterKey").getValue(),d=new sap.ui.model.Filter(c,sap.ui.model.FilterOperator.Contains,b),e=a.getSource().getBinding("items");e.filter([d])},handleValueHelpDialogOKPress:function(a){var b=this._getCustomDataForKey(this._oSearchInputField,"filterKey").getValue(),c=this._getCustomDataForKey(this._oSearchInputField,"BindingKey").getValue(),d=a.getParameter("selectedContexts"),e=d.map(function(a){return a.getProperty(b)}),f=d.map(function(a){return a.getProperty(c)});this._oSearchInputField.setValue(f.join(", ")),this._getCustomDataForKey(this._oSearchInputField,"filterValue")&&this._oSearchInputField.removeCustomData(this._getCustomDataForKey(this._oSearchInputField,"filterValue")),e.length>0&&this._oSearchInputField.addCustomData(new sap.ui.core.CustomData({key:"filterValue",value:e})),this._getCustomDataForKey(this.byId("seasonInput"),"filterValue")||this._setCurrentSeasonSelected();var g=this.getView().byId("shipmentNumberInput"),h=this.getView().byId("deliveryNumberInput"),i=this.getView().byId("containerIDInput"),j=this.getView().byId("lineNumberInput");this._oSearchInputField.getId()===this.createId("seasonInput")&&(g.setValue(""),this._getCustomDataForKey(g,"filterValue")&&g.removeCustomData(this._getCustomDataForKey(g,"filterValue"))),this._oSearchInputField.getId()===this.createId("shipmentNumberInput")&&(h.setValue(""),this._getCustomDataForKey(h,"filterValue")&&h.removeCustomData(this._getCustomDataForKey(h,"filterValue")),i.setValue(""),this._getCustomDataForKey(i,"filterValue")&&i.removeCustomData(this._getCustomDataForKey(i,"filterValue")),j.setValue(""),this._getCustomDataForKey(j,"filterValue")&&j.removeCustomData(this._getCustomDataForKey(j,"filterValue"))),this._oSearchInputField.getId()===this.createId("deliveryNumberInput")&&(j.setValue(""),this._getCustomDataForKey(j,"filterValue")&&j.removeCustomData(this._getCustomDataForKey(j,"filterValue")))},handleFilterPress:function(){jQuery.device.is.desktop?this._applyFilter():(this.byId("continueButton").focus(),window.setTimeout(this._applyFilter.bind(this),0))},_applyFilter:function(){for(var a=[],b=0;b<this._aSearchInputIDs.length;){var c=this.getView().byId(this._aSearchInputIDs[b]),d=[];if("exemptionStatusInput"===this._aSearchInputIDs[b]){var e="";if(this._getCustomDataForKey(c,"filterButtonKey")&&(e=this._getCustomDataForKey(c,"filterButtonKey").getValue()),this._getCustomDataForKey(c,"filterValue")){var f=this._getCustomDataForKey(c,"filterValue").getValue();for(var g in f){var h=null;switch(f[g]){case com.zespri.awct.util.Enums.ExemptionStatus.NONE:h=new sap.ui.model.Filter(e,"EQ",com.zespri.awct.util.Enums.ExemptionStatus.NONE);break;case com.zespri.awct.util.Enums.ExemptionStatus.PENDING:h=new sap.ui.model.Filter(e,"EQ",com.zespri.awct.util.Enums.ExemptionStatus.PENDING);break;case com.zespri.awct.util.Enums.ExemptionStatus.COMPLETE:h=new sap.ui.model.Filter(e,"EQ",com.zespri.awct.util.Enums.ExemptionStatus.COMPLETE)}d.push(h)}var i=new sap.ui.model.Filter(d,!1);a.push(i)}}else{var j="";if(this._getCustomDataForKey(c,"filterButtonKey")&&(j=this._getCustomDataForKey(c,"filterButtonKey").getValue()),this._getCustomDataForKey(c,"filterValue")){var k=this._getCustomDataForKey(c,"filterValue").getValue();for(var l in k){var m=new sap.ui.model.Filter(j,"EQ",k[l]);d.push(m)}var n=new sap.ui.model.Filter(d,!1);a.push(n)}}b+=1}var o=this.getView().byId("fromDateInput");if(o.getValue()){var p=new sap.ui.model.Filter(this._getCustomDataForKey(o,"filterButtonKey").getValue(),"EQ",this._getExternalFormatValue(o.getYyyymmdd(),!1));a.push(p)}var q=this.getView().byId("toDateInput");if(q.getValue()){var r=new sap.ui.model.Filter(this._getCustomDataForKey(q,"filterButtonKey").getValue(),"EQ",this._getExternalFormatValue(q.getYyyymmdd(),!1));a.push(r)}var s=new sap.ui.model.Filter(a,!0),t=com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_ORDERHISTORY_FILTER_TOOLBAR_TEXT")+this._getFilterString(),u=this._getDownloadFilterString();s.aFilters.length||(s=null,t=com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_ORDERHISTORY_FILTER_TOOLBAR_NO_FILTER_TEXT")),this.getRouter().navTo("Collaboration/TrackOrders",{customData:{searchFormFilterObject:s,searchFormFilterString:t,downloadFilterString:u}})},handleResetPress:function(){var a=this.getView();jQuery.each(this._aSearchInputIDs,function(b,c){var d=a.byId(c);d.setValue(""),a.getController()._getCustomDataForKey(d,"filterValue")&&d.removeCustomData(a.getController()._getCustomDataForKey(d,"filterValue"))}),this._setCurrentSeasonSelected()},_setCurrentSeasonSelected:function(){var a=this.byId("seasonInput"),b=sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason;a.setValue(b),a.addCustomData(new sap.ui.core.CustomData({key:"filterValue",value:[b]}))},_getExternalFormatValue:function(a,b){var c=a.substring(0,4),d=a.substring(4,6),e=a.substring(6,8);return b?"datetime'"+c+"-"+d+"-"+e+"T00:00:00'":c+"-"+d+"-"+e}})}();