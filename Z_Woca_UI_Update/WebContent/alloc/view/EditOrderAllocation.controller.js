/*----------------------------------------------------------------------* 
 * Copyright  (c) 2014 SAP SE. All rights reserved	
 * Author       : SAP Custom Development 
 *----------------------------------------------------------------------*/ 
	!function(){"use strict";jQuery.sap.require({modName:"com.zespri.awct.core.Controller",type:"controller"}),jQuery.sap.require("com.zespri.awct.util.CommonHelper"),jQuery.sap.require("com.zespri.awct.util.Enums"),jQuery.sap.require("com.zespri.awct.util.CommonFormatHelper"),jQuery.sap.require("com.zespri.awct.util.LocaleFormatHelper"),jQuery.sap.require("com.zespri.awct.util.ModelHelper"),jQuery.sap.require("com.zespri.awct.util.NotificationHelper"),jQuery.sap.require("com.zespri.awct.util.TableRowActionsExtension"),jQuery.sap.require("sap.ui.commons.layout.HorizontalLayout"),com.zespri.awct.core.Controller.extend("com.zespri.awct.alloc.view.EditOrderAllocation",{_ChargeCodes:{NonChargeTotal:"NCT",NonChargeSubTotal:"NCS",AdministrativeCharges:"Z-CSO-A"},_DeliveryAdditionalInfoKey:{DemandGTSupply:"03",BCNotMaintained:"01"},_ShipmentType:{Container:"02",Charter:"01"},_MaintainBCBusinessAction:{Update:"UPDATE",Overwrite:"OVERWRITE"},_MaintainBCOperation:{Include:"I",Exclude:"E",Delete:"D"},_AllocationMacro:{ProRata:"ProRata",Zero:"Zero"},onExit:function(){this._oRowActionsExtension&&this._oRowActionsExtension.destroy(),this._oLockedDeliverySaveDialog&&this._oLockedDeliverySaveDialog.destroy()},onInit:function(){this._oUnlockDeliveryDialog=null,this._sReason="",this._oDialogMaintainLineText=null,this._oDialogMaintainHeaderText=null,this._oDialogAddSupplier=null,this._oMarketInfoDialog=null,this._oDeliveryHeaderContext=null,this._oReleaseDeliveryDialog=null,this._oRowActionsExtension=null,this._mAllocationQuantityChanges={},this._aInvalidAllocationQuantityInputs=[],this._aChangedInputs=[],this._iUniqueStringCounter=0,this._oMaintainBatchCharacteristicsDialog=null,this._oMaintainBatchCharacteristicsSearchHelpDialog=null,this._oMaintainBatchCharacteristicsPropagateToLinesDialog=null,this._oMaintainBatchCharacteristicsModel=null,this._oViewStateModel=null,this._bSimulatingMacro=!1,this._mMacroSimulationTargets={},this._oMacrosActionSheet=null,this._oBusyDialog=new sap.m.BusyDialog,this._oAddSuppliersToContainerDialog=null,this._oAddSuppliersToContainerSearchInputField=null,this._oAddSuppliersToContainerSearchHelpDialog=null,this._oAddSupplierButton=null,this._bUserAuthorized=!1,this._oLockedDeliverySaveDialog=null;var a=this,b=this.getView();this._oViewStateModel=new sap.ui.model.json.JSONModel({allowAllocationChange:!1}),this.getView().setModel(this._oViewStateModel,"viewState");var c=this.byId("allocationTable"),d=this.byId("facetFilterAllocation");com.zespri.awct.util.CommonHelper.manageFacetFilterState(c,d),com.zespri.awct.util.CommonHelper.manageNoDataText(c),this._oRowActionsExtension=new com.zespri.awct.util.TableRowActionsExtension({table:c,actionsContent:this._getTableRowActionsContent()}),this._oRowActionsExtension.attachOnBeforeActionsVisible(this._handleOnBeforeActionsVisible,this);var e=function(c){if("Allocation/EditOrderAllocation"===c.getParameter("name")){if(!a._bUserAuthorized)return void com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_USER_NOT_AUTHORIZED_MESSAGE_TEXT"));a.getRouter().attachOnBeforeNavigationWithUnsavedChanges(this.handleNavigationWithUnsavedChanges,this);var d=c.getParameter("arguments").contextPath;this._oDeliveryHeaderContext=new sap.ui.model.Context(b.getModel(),"/"+d),this._setViewBusy(!0);var g=this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID");if(g)f();else{var h=function(b){a._oDeliveryHeaderContext=new sap.ui.model.Context(b,"/result"),f()},i=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a)};com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{},h,i)}}else a.getRouter().detachOnBeforeNavigationWithUnsavedChanges(this.handleNavigationWithUnsavedChanges,this),this.getRouter().detachRoutePatternMatched(e,this),this.getRouter().removeViewFromCache("com.zespri.awct.alloc.view.EditOrderAllocation"),this.getView().destroy(!0)};this.getRouter().attachRoutePatternMatched(e,this);var f=function(){com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Maintain,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)&&(a.byId("maintainHeaderTextButton").setVisible(!0),a._oDeliveryHeaderContext.getProperty("Status")===com.zespri.awct.util.Enums.DeliveryStatus.Released?(a.byId("lockButton").setVisible(!0),a.byId("unlockButton").setVisible(!1)):a._oDeliveryHeaderContext.getProperty("Status")===com.zespri.awct.util.Enums.DeliveryStatus.Locked&&(a.byId("lockButton").setVisible(!1),a.byId("unlockButton").setVisible(!0))),a._refreshTable(),a._updateFooter(),a._updateQuantityInputsEnabledState();var b=a._oDeliveryHeaderContext.getModel();a._setViewBusy(!1),a.byId("deliveryObjectHeader").setModel(b).setBindingContext(a._oDeliveryHeaderContext).setBusy(!1),a._initFacetFilterLists(),a._initTableConfiguration()}},onBeforeRendering:function(){com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Display,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)?this._bUserAuthorized=!0:(this.byId("pageEditOrderAllocation")&&this.byId("pageEditOrderAllocation").destroy(),this._bUserAuthorized=!1)},_handleOnBeforeActionsVisible:function(a){var b=a.getParameter("rowContext");b.getProperty("TextExistsFlag")?this._oDeliveryLineTextButton.addStyleClass("zAwctDeliveryLineTextButtonBackgroundColor"):this._oDeliveryLineTextButton.removeStyleClass("zAwctDeliveryLineTextButtonBackgroundColor")},createTableColumnListItem:function(a,b){var c=b.getProperty("RecordType"),d="allocationLine"+this._iUniqueStringCounter++,e;switch(c){case com.zespri.awct.util.Enums.AllocationLineRecordType.DeliveryLine:e=sap.ui.xmlfragment(d,"com.zespri.awct.alloc.fragment.EditAllocationsDeliveryLineTemplate",this);break;case com.zespri.awct.util.Enums.AllocationLineRecordType.SupplierOrderLine:e=sap.ui.xmlfragment(d,"com.zespri.awct.alloc.fragment.EditAllocationsSupplierOrderLineTemplate",this);break;default:e=sap.ui.xmlfragment(d,"com.zespri.awct.alloc.fragment.EditAllocationsDeliveryLineTemplate",this),jQuery.sap.log.error("Unexpected RecordType ("+c+") in /AllocationLineSet")}if(this._oDeliveryHeaderContext.getProperty("ContainerOrCharter")===this._ShipmentType.Charter&&(e.removeCell(sap.ui.core.Fragment.byId(d,"containerIDCell")),sap.ui.core.Fragment.byId(d,"containerIDCell").destroy(),e.removeCell(sap.ui.core.Fragment.byId(d,"containerTypeCell")),sap.ui.core.Fragment.byId(d,"containerTypeCell").destroy()),this._bSimulatingMacro&&c===com.zespri.awct.util.Enums.AllocationLineRecordType.SupplierOrderLine){var f=b.getProperty("DeliveryAllocationID"),g=sap.ui.core.Fragment.byId(d,"allocationQuantityCell");this._mMacroSimulationTargets[f]=g}return e},formatAllocationQuantityEnableState:function(a){return com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Maintain,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)?a:!1},formatDeliveryLineAllocationQuantityState:function(a,b){return a===b?sap.ui.core.ValueState.Success:sap.ui.core.ValueState.Error},handleAllocationQuantityChange:function(a){var b=a.getSource(),c=b.getBindingContext(),d=b.getValue(),e;if(""===d||parseInt(d,10)<0)return b.setValueState(sap.ui.core.ValueState.Error),void this._aInvalidAllocationQuantityInputs.push(b);e=parseInt(d,10),b.setValueState(sap.ui.core.ValueState.None);var f=this._aInvalidAllocationQuantityInputs.indexOf(b);f>-1&&this._aInvalidAllocationQuantityInputs.splice(f,1);var g=c.getPath(),h={DeliveryAllocationID:c.getProperty("DeliveryAllocationID"),AllocationQuantity:parseFloat(e)+"",DeliveryLineUpdateTime:com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getProperty("DeliveryLineUpdateTime"),!0),AllocationUpdateTime:com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getProperty("AllocationUpdateTime"),!0)};b.setValue(e),this._mAllocationQuantityChanges[g]=h,this._aChangedInputs.push(b),this.setHasUnsavedChanges(!0)},handleDeliveryLineTextPress:function(a){var b=this,c,d,e,f,g={};if(!b._stopActionIfViewDirty()){this._oRowActionsExtension.hideRowActions();var h=a.getSource().getBindingContext(),i=function(a){b._oDialogMaintainLineText.setModel(a,"standardTexts"),c.resolve()};b._oDialogMaintainLineText||(b._oDialogMaintainLineText=new sap.ui.xmlfragment("maintainLineTextFragment","com.zespri.awct.alloc.fragment.MaintainLineText",b),b._oDialogMaintainLineText.setModel(this.getView().getModel("i18n"),"i18n"),this.getView().addDependent(b._oDialogMaintainLineText));var j=sap.ui.core.Fragment.byId("maintainLineTextFragment","maintainLineTextTable");com.zespri.awct.util.CommonHelper.manageNoDataText(j),sap.ui.core.Fragment.byId("maintainLineTextFragment","deliveryLineTextOKButton").setEnabled(!1),sap.ui.core.Fragment.byId("maintainLineTextFragment","maintainLineTextTextArea").attachEventOnce("liveChange",function(){sap.ui.core.Fragment.byId("maintainLineTextFragment","deliveryLineTextOKButton").setEnabled(!0)}),sap.ui.core.Fragment.byId("maintainLineTextFragment","maintainLineTextSearchField").setValue(""),sap.ui.core.Fragment.byId("maintainLineTextFragment","maintainLineTextTextArea").setValue(""),c=$.Deferred(),d=c.promise(),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/TextStandardSet",{},i),g.success=function(a){var b=sap.ui.core.Fragment.byId("maintainLineTextFragment","maintainLineTextTextArea");b.setValue(a.TextString),e.resolve()},g.error=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),e.resolve()},e=$.Deferred(),f=e.promise(),b.getView().getModel().read(h+"/Text",g),b._oDialogMaintainLineText.setBusy(!0),b._oDialogMaintainLineText.open(),$.when(d,f).done(function(){b._oDialogMaintainLineText.setBusy(!1)})}},handleDeliveryLineTextOKPress:function(){var a=this,b={},c={},d=sap.ui.core.Fragment.byId("maintainLineTextFragment","maintainLineTextTextArea"),e=a.getView().byId("allocationTable").getSelectedItem().getBindingContext();b.TextString=d.getValue(),b.DeliveryHeaderID=e.getProperty("DeliveryHeaderID"),b.DeliveryLineID=e.getProperty("DeliveryLineID"),c.success=function(){com.zespri.awct.util.NotificationHelper.showSuccessToast(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_MAINTAINLINETEXT_UPDATE_SUCCESS")),a._oDialogMaintainLineText.setBusy(!1),a._oDialogMaintainLineText.close()},c.error=function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._oDialogMaintainLineText.setBusy(!1)},c.async=!0,a._oDialogMaintainLineText.setBusy(!0),a.getView().getModel().create("/TextSet",b,c),a.getView().byId("allocationTable").getBinding("items").refresh()},handleDeliveryLineTextCancelPress:function(){this._oDialogMaintainLineText.close()},handleDeliveryLineTextSearchLiveChange:function(a){var b=a.getParameter("newValue"),c=new sap.ui.model.Filter("TextStandardID",sap.ui.model.FilterOperator.Contains,b),d=sap.ui.core.Fragment.byId("maintainLineTextFragment","maintainLineTextTable").getBinding("items");d.filter([c])},handleDeliveryLineTextAddButtonPress:function(a){sap.ui.core.Fragment.byId("maintainLineTextFragment","maintainLineTextTextArea").fireLiveChange();var b=a.getSource().getBindingContext("standardTexts").getProperty("Value"),c=sap.ui.core.Fragment.byId("maintainLineTextFragment","maintainLineTextTextArea"),d=c.getValue();c.setValue(""===d?b:d+"\n"+b);var e=c.getFocusDomRef();e.selectionStart===e.selectionEnd&&(e.scrollTop=e.scrollHeight)},handleDeliveryHeaderTextOpen:function(){var a=this,b,c,d,e;if(!a._stopActionIfViewDirty()){var f={},g=function(c){a._oDialogMaintainHeaderText.setModel(c,"standardTexts"),b.resolve()};a._oDialogMaintainHeaderText||(a._oDialogMaintainHeaderText=new sap.ui.xmlfragment("maintainHeaderTextFragment","com.zespri.awct.alloc.fragment.MaintainHeaderText",a),a._oDialogMaintainHeaderText.setModel(a.getView().getModel("i18n"),"i18n"),this.getView().addDependent(a._oDialogMaintainHeaderText));var h=sap.ui.core.Fragment.byId("maintainHeaderTextFragment","maintainHeaderTextTable");com.zespri.awct.util.CommonHelper.manageNoDataText(h),sap.ui.core.Fragment.byId("maintainHeaderTextFragment","deliveryHeaderTextOKButton").setEnabled(!1),sap.ui.core.Fragment.byId("maintainHeaderTextFragment","maintainHeaderTextTextArea").attachEventOnce("liveChange",function(){sap.ui.core.Fragment.byId("maintainHeaderTextFragment","deliveryHeaderTextOKButton").setEnabled(!0)}),sap.ui.core.Fragment.byId("maintainHeaderTextFragment","maintainHeaderTextSearchField").setValue(""),sap.ui.core.Fragment.byId("maintainHeaderTextFragment","maintainHeaderTextTextArea").setValue(""),b=jQuery.Deferred(),c=b.promise(),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/TextStandardSet",{},g);var i=sap.ui.core.Fragment.byId("maintainHeaderTextFragment","maintainHeaderTextTextArea"),j=a._oDeliveryHeaderContext.getProperty("DeliveryHeaderID");f.success=function(a){i.setValue(a.TextString),d.resolve()},f.error=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),d.resolve()},d=jQuery.Deferred(),e=d.promise(),a.getView().getModel().read("/DeliveryHeaderSet('"+j+"')/Text",f),a._oDialogMaintainHeaderText.setBusy(!0),a._oDialogMaintainHeaderText.open(),$.when(c,e).done(function(){a._oDialogMaintainHeaderText.setBusy(!1)})}},handleDeliveryHeaderTextAddButtonPress:function(a){sap.ui.core.Fragment.byId("maintainHeaderTextFragment","maintainHeaderTextTextArea").fireLiveChange();var b=a.getSource().getBindingContext("standardTexts").getProperty("Value"),c=sap.ui.core.Fragment.byId("maintainHeaderTextFragment","maintainHeaderTextTextArea"),d=c.getValue();c.setValue(""===d?b:d+"\n"+b);var e=c.getFocusDomRef();e.selectionStart===e.selectionEnd&&(e.scrollTop=e.scrollHeight)},handleDeliveryHeaderTextSearchLiveChange:function(a){var b=a.getParameter("newValue"),c=new sap.ui.model.Filter("TextStandardID",sap.ui.model.FilterOperator.Contains,b),d=sap.ui.core.Fragment.byId("maintainHeaderTextFragment","maintainHeaderTextTable").getBinding("items");d.filter([c])},handleDeliveryHeaderTextOKPress:function(){var a=this,b={},c={},d=a._oDeliveryHeaderContext.getProperty("DeliveryHeaderID"),e=sap.ui.core.Fragment.byId("maintainHeaderTextFragment","maintainHeaderTextTextArea");b.TextString=e.getValue(),b.DeliveryHeaderID=d,c.success=function(){com.zespri.awct.util.NotificationHelper.showSuccessToast(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_MAINTAINHEADERTEXT_UPDATE_SUCCESS")),a._oDialogMaintainHeaderText.setBusy(!1),a._oDialogMaintainHeaderText.close()},c.error=function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._oDialogMaintainHeaderText.setBusy(!1)},c.async=!0,a._oDialogMaintainHeaderText.setBusy(!0),a.getView().getModel().create("/TextSet",b,c)},handleDeliveryHeaderTextCancelPress:function(){this._oDialogMaintainHeaderText.close()},handleLineActionsPress:function(a){var b=a.getSource();this._oActionSheet||(this._oActionSheet=sap.ui.xmlfragment("allocationActionSheetFragment","com.zespri.awct.alloc.fragment.AllocationActionSheet",this),this.getView().addDependent(this._oActionSheet)),this._oActionSheet.openBy(b)},formatActionSheetVisible:function(a,b){return a||b?!0:!1},_getTableRowActionsContent:function(){var a=sap.ui.getCore().getRootComponent().getModel("i18n"),b=sap.ui.getCore().getRootComponent().getModel();this._oDeliveryLineTextButton=new sap.m.Button({icon:"sap-icon://document-text",tooltip:{path:"TextExistsFlag",formatter:this._formatDeliveryLineTextButtonTooltip},visible:!1,press:[this.handleDeliveryLineTextPress,this]}),this._oAddSupplierButton=new sap.m.Button({icon:"sap-icon://supplier",enabled:"{viewState>/allowAllocationChange}",visible:!1,tooltip:"{i18n>TXT_ALLOCATION_EDITALLOCATIONS_ADD_SUPPLIERS_TOOLTIP}",press:[this.handleAddNewSuppliersButtonPress,this]});var c=new sap.ui.commons.layout.HorizontalLayout({content:[this._oDeliveryLineTextButton,new sap.m.Button({icon:"sap-icon://dimension",tooltip:"{i18n>TXT_ALLOCATION_MAINTAIN_BATCH_CHARACTERISTICS_TOOLTIP}",press:[this.handleMaintainBatchCharacteristicsOpen,this]}),this._oAddSupplierButton,new sap.m.Button({icon:"sap-icon://order-status",tooltip:"{i18n>TXT_ALLOCATION_EDITALLOCATIONS_SUPPLY_PLAN_BUTTON_TOOLTIP}",press:[this.handleSupplyPlanNavigation,this]})]});return com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Maintain,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)&&(this._oDeliveryLineTextButton.setVisible(!0),this._oAddSupplierButton.setVisible(!0)),c.setModel(a,"i18n"),c.setModel(this._oViewStateModel,"viewState"),c.setModel(b),c},handleSupplyPlanNavigation:function(a){var b=a.getSource().getBindingContext().getProperty("DeliveryLineID");this.getRouter().navTo("Allocation/SupplyPlan",{DeliveryLineID:b})},_formatDeliveryLineTextButtonTooltip:function(a){return com.zespri.awct.util.I18NHelper.getText(a?"TXT_ALLOCATION_EDITALLOCATIONS_DELIVERY_LINE_TEXT_EXISTS_TOOLTIP":"TXT_ALLOCATION_EDITALLOCATIONS_DELIVERY_LINE_TEXT_TOOLTIP")},handleRowActionsPress:function(a){this._oRowActionsExtension.showRowActions(a.getSource().getBindingContext())},handleAddNewSuppliersButtonPress:function(a){if(!this._stopActionIfViewDirty()){this._oRowActionsExtension.hideRowActions();var b=this,c=a.getSource().getBindingContext(),d=c.getProperty("UOM"),e=c.getProperty("DeliveryLineNumber"),f=c.getProperty("DeliveryHeaderID"),g=c.getProperty("DeliveryLineID"),h=c.getProperty("DeliveryLineUpdateTime"),i=function(a){if(0===a.getData().results.length){var c=sap.ui.core.Fragment.byId("addSupplierDialog","addSupplierTable");c.destroyItems(),c.setProperty("noDataText",com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_ADDSUPPLIER_TABLE_NO_ADDITIONAL_SUPPLIERS")),c.setBusy(!1)}else a.setProperty("/UOM",d),a.setProperty("/DeliveryLineNumber",e),a.setProperty("/DeliveryHeaderID",f),a.setProperty("/DeliveryLineID",g),a.setProperty("/DeliveryLineUpdateTime",h),b._oDialogAddSupplier.setModel(a,"addSuppliersModel");b._oDialogAddSupplier.setBusy(!1)};com.zespri.awct.util.ModelHelper.getJSONModelForRead("/GetUnassignedSuppliers",{urlParameters:{DeliveryLineID:"'"+g+"'"}},i),b._oDialogAddSupplier||(b._oDialogAddSupplier=new sap.ui.xmlfragment("addSupplierDialog","com.zespri.awct.alloc.fragment.AddSupplier",this),b.getView().addDependent(b._oDialogAddSupplier)),b._oDialogAddSupplier.setBusy(!0);var j=sap.ui.core.Fragment.byId("addSupplierDialog","supplierRel2RelevantCheckbox");j.setSelected(!0),j.setVisible(this._oDeliveryHeaderContext.getProperty("Status")===com.zespri.awct.util.Enums.DeliveryStatus.Locked?!0:!1);var k=sap.ui.core.Fragment.byId("addSupplierDialog","addSupplierTable");com.zespri.awct.util.CommonHelper.manageNoDataText(k),sap.ui.core.Fragment.byId("addSupplierDialog","addSupplierSearchField").setValue(""),b._oDialogAddSupplier.open()}},handleFacetListClose:function(){this._stopActionIfViewDirty()||this.byId("facetFilterAllocation").getFiltersModifiedAfterListOpen()&&(this.byId("allocationTable").setBusy(!0),this._refreshTable())},handleSavePress:function(){if(jQuery.sap.assert(this.getHasUnsavedChanges(),"Save was clicked even though there is nothing to be saved!"),jQuery.sap.assert(!jQuery.isEmptyObject(this._mAllocationQuantityChanges),"Save was clicked even though there are no tracked quantity changes!"),0!==this._aInvalidAllocationQuantityInputs.length){var a=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_ERRORS_BEFORE_SAVE_TOAST");return void com.zespri.awct.util.NotificationHelper.showErrorToast(a)}this._oDeliveryHeaderContext.getProperty("Status")===com.zespri.awct.util.Enums.DeliveryStatus.Locked?(this._oLockedDeliverySaveDialog||(this._oLockedDeliverySaveDialog=new sap.ui.xmlfragment("LockedDeliverySaveFragment","com.zespri.awct.alloc.fragment.EditAllocationsLockedDeliverySaveDialog",this),this.getView().addDependent(this._oLockedDeliverySaveDialog)),sap.ui.core.Fragment.byId("LockedDeliverySaveFragment","supplierRel2RelevantCheckbox").setSelected(!0),this._oLockedDeliverySaveDialog.open()):this._saveBatchUpdate()},handleEditAllocationsLockedDeliveryOKPress:function(){this._saveBatchUpdate(),this._oLockedDeliverySaveDialog.close()},handleEditAllocationsLockedDeliveryClose:function(){this._oLockedDeliverySaveDialog.close()},_saveBatchUpdate:function(){var a=[],b=this.getView().getModel();this._oDeliveryHeaderContext.getProperty("Status")===com.zespri.awct.util.Enums.DeliveryStatus.Locked&&b.setHeaders({"REL2-RELEVANT":sap.ui.core.Fragment.byId("LockedDeliverySaveFragment","supplierRel2RelevantCheckbox").getSelected()}),jQuery.each(this._mAllocationQuantityChanges,function(c,d){var e=b.createBatchOperation(c,"PATCH",d);a.push(e)}),this._setViewBusy(!0);var c=this;b.addBatchChangeOperations(a),b.submitBatch(function(a,d,e){b.setHeaders(null),com.zespri.awct.util.NotificationHelper.handleErrorMessage(e),jQuery.sap.log.info("Allocation : Batch update was successful."),c._aChangedInputs=[],c._mAllocationQuantityChanges={},c._setViewBusy(!1),c.setHasUnsavedChanges(!1),c._refreshTable()},function(a){b.setHeaders(null),jQuery.sap.log.error("Allocation : Batch update failed."),com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._setViewBusy(!1)})},_setViewBusy:function(a){this.getView().setBusy(a),this.byId("pageEditOrderAllocation").getFooter().setBusy(a)},handleDiscardChangesPress:function(){jQuery.sap.assert(this.getHasUnsavedChanges(),"Cancel was clicked even though there is nothing to be saved!");var a=this,b=function(){a._mAllocationQuantityChanges={},jQuery.each(a._aInvalidAllocationQuantityInputs,function(a,b){b.setValueState(sap.ui.core.ValueState.None)}),a._aInvalidAllocationQuantityInputs=[],jQuery.each(a._aChangedInputs,function(a,b){b.getBinding("value").refresh(!0)}),a._aChangedInputs=[],a.setHasUnsavedChanges(!1);var b=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_CHANGES_DISCARDED_TOAST");com.zespri.awct.util.NotificationHelper.showSuccessToast(b)},c=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_CONFIRM_DISCARD_CHANGES_DIALOG");com.zespri.awct.util.NotificationHelper.showConfirmDialog(c,b)},handleMaintainBatchCharacteristicsOpen:function(a){var b,c,d,e,f=this;if(!this._stopActionIfViewDirty()){var g=a.getSource().getBindingContext().getProperty("DeliveryLineID");if(!com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Maintain,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)||this._oDeliveryHeaderContext.getProperty("Status")===com.zespri.awct.util.Enums.DeliveryStatus.Released)return void this._openViewBatchCharacteristicsDialog(g);this._oMaintainBatchCharacteristicsDialog?(sap.ui.core.Fragment.byId("maintainBCDialog","propagateToLinesCheckBox").setSelected(!1),sap.ui.core.Fragment.byId("maintainBCDialog","propagateToLinesInput").setEnabled(!1),sap.ui.core.Fragment.byId("maintainBCDialog","propagateUpdateRadioButton").setEnabled(!1),sap.ui.core.Fragment.byId("maintainBCDialog","propagateOverwriteRadioButton").setEnabled(!1)):(this._oMaintainBatchCharacteristicsDialog=sap.ui.xmlfragment("maintainBCDialog","com.zespri.awct.alloc.fragment.EditAllocationsMaintainBatchCharacteristics",this),this.getView().addDependent(this._oMaintainBatchCharacteristicsDialog));var h=sap.ui.core.Fragment.byId("maintainBCDialog","maintainBCTable");com.zespri.awct.util.CommonHelper.manageNoDataText(h),h.addCustomData(new sap.ui.core.CustomData({key:"loadingData",value:!0})),this._oMaintainBatchCharacteristicsModel&&this._oMaintainBatchCharacteristicsModel.destroy(),this._oMaintainBatchCharacteristicsModel=new sap.ui.model.json.JSONModel,this._oMaintainBatchCharacteristicsDialog.setModel(this._oMaintainBatchCharacteristicsModel,"maintainBC"),this._oMaintainBatchCharacteristicsModel.setProperty("/isPropagateSelected",!1);var i=a.getSource().getBindingContext().getProperty("DeliveryLineNumber"),j=a.getSource().getBindingContext().getProperty("DeliveryHeaderID");this._oMaintainBatchCharacteristicsModel.setProperty("/CurrentDeliveryLineNumber",i),this._oMaintainBatchCharacteristicsModel.setProperty("/CurrentDeliveryHeaderID",j),this._oMaintainBatchCharacteristicsModel.setProperty("/CurrentDeliveryLineID",g),this._oRowActionsExtension.hideRowActions(),this._oMaintainBatchCharacteristicsDialog.setBusy(!0),this._oMaintainBatchCharacteristicsDialog.open(),b=jQuery.Deferred(),c=b.promise(),this.getView().getModel().read("/BatchCharacteristicsSet",{urlParameters:{$filter:"DeliveryLineID eq '"+g+"'",$expand:"BatchCharacteristicsValueSet"},success:function(a){k(a)}}),d=jQuery.Deferred(),e=d.promise(),this.getView().getModel().read("/BatchCharStandardSet",{success:function(a){l(a)}}),jQuery.when(c,e).done(function(){f._oMaintainBatchCharacteristicsDialog.setBusy(!1),f._updateBatchCharacteristicsItemEnabled(),h.removeAllCustomData()});var k=function(a){var b=a.results;$.each(b,function(a,b){b.editable=!1,b.BCNameSelected=!0,$.each(b.BatchCharacteristicsValueSet.results,function(a,b){b.Key=b.Value})}),b.push({BatchCharacteristicsID:"",BatchCharacteristicsValueSet:{results:[]},CharacteristicName:"",DeliveryLineID:g,BCNameSelected:!1,Operation:f._MaintainBCOperation.Include}),f._oMaintainBatchCharacteristicsModel.setProperty("/BatchCharacteristics",b),d.resolve()},l=function(a){var c=a.results;c.unshift({BatchCharName:"",enabled:!1}),f._oMaintainBatchCharacteristicsModel.setProperty("/BatchCharacteristicsDomainValues",c),b.resolve()}}},_openViewBatchCharacteristicsDialog:function(a){this._oViewBatchCharacteristicsDialog||(this._oViewBatchCharacteristicsDialog=sap.ui.xmlfragment("viewBCDialog","com.zespri.awct.alloc.fragment.ViewBatchCharacteristics",this),this.getView().addDependent(this._oViewBatchCharacteristicsDialog)),com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Maintain,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)||sap.ui.core.Fragment.byId("viewBCDialog","viewBCToolBar").getContent()[0].setText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_VIEW_BATCH_CHARACTERISTICS_TOOLBAR_NOT_AUTHORIZES_TEXT")),this._oViewBatchCharacteristicsDialog.setBusy(!0),this._oViewBatchCharacteristicsDialog.open();var b=this;this._oRowActionsExtension.hideRowActions(),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/BatchCharacteristicsSet",{urlParameters:{$filter:"DeliveryLineID eq '"+a+"'",$expand:"BatchCharacteristicsValueSet"}},function(a){b._oViewBatchCharacteristicsDialog.setModel(a);var c=a.getData().results.length;sap.ui.core.Fragment.byId("viewBCDialog","viewBatchCharacteristicsTableHeader").setText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_VIEW_BATCH_CHARACTERISTICS_TABLE_TITLE",[c])),b._oViewBatchCharacteristicsDialog.setBusy(!1)})},handleViewBatchCharacteristicsOKPress:function(){this._oViewBatchCharacteristicsDialog.close()},handleMaintainBatchCharacteristicsCancel:function(){this._oMaintainBatchCharacteristicsDialog.close()},formatViewBatchCharacteristicsValuesText:function(a){var b=function(a){return a.Value};return a.results.map(b).join(", ")},formatViewBatchCharacteristicsOptionText:function(a){return a===com.zespri.awct.util.Enums.ViewBCOperation.Exclude?com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_VIEW_BATCH_CHARACTERISTICS_EXCLUDE"):a===com.zespri.awct.util.Enums.ViewBCOperation.Include?com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_VIEW_BATCH_CHARACTERISTICS_INCLUDE"):""},formatCopyFlagCheckBoxEnabled:function(a,b){return a&&b?!0:!1},handleMaintainBatchCharacteristicsPropagateSelect:function(a){var b=a.getParameter("selected"),c=sap.ui.core.Fragment.byId("maintainBCDialog","propagateToLinesInput"),d=sap.ui.core.Fragment.byId("maintainBCDialog","propagateUpdateRadioButton"),e=sap.ui.core.Fragment.byId("maintainBCDialog","propagateOverwriteRadioButton");b?(c.setEnabled(!0),d.setEnabled(!0),e.setEnabled(!0),this._oMaintainBatchCharacteristicsModel.setProperty("/isPropagateSelected",!0)):(c.setEnabled(!1),d.setEnabled(!1),e.setEnabled(!1),this._oMaintainBatchCharacteristicsModel.setProperty("/isPropagateSelected",!1))},handleMaintainBatchCharacteristicsSave:function(){var a=this._oMaintainBatchCharacteristicsDialog.getModel("maintainBC"),b=!1,c=this,d=[],e="",f=a.getProperty("/BatchCharacteristics"),g=!1;if($.each(f,function(a,c){return""===c.CharacteristicName?!0:0===c.BatchCharacteristicsValueSet.results.length?(b=!0,c.error=!0,!0):(c.CopyFlag&&(g=!0),void d.push(c))}),b)return a.setProperty("/BatchCharacteristics",f),e=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_MAINTAIN_BATCH_CHARACTERISTICS_ERROR_CORRECT_HIGHLIGHTED_FIELDS"),void com.zespri.awct.util.NotificationHelper.showErrorToast(e);var h=sap.ui.core.Fragment.byId("maintainBCDialog","propagateToLinesCheckBox");if(!g&&h.getSelected())return e=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_MAINTAIN_BATCH_CHARACTERISTICS_ERROR_NO_COPY_FLAG"),void com.zespri.awct.util.NotificationHelper.showErrorToast(e);var i=a.getProperty("/PropagateToLines"),j=sap.ui.core.Fragment.byId("maintainBCDialog","propagateToLinesInput");if(h.getSelected()&&""===j.getValue())return e=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_MAINTAIN_BATCH_CHARACTERISTICS_ERROR_NO_TARGET_LINES"),void com.zespri.awct.util.NotificationHelper.showErrorToast(e);var k,l=sap.ui.core.Fragment.byId("maintainBCDialog","propagateUpdateRadioButton");h.getSelected()&&(k=l.getSelected()?this._MaintainBCBusinessAction.Update:this._MaintainBCBusinessAction.Overwrite),k&&this.getView().getModel().setHeaders({BusinessAction:k});var m=[];$.each(f,function(b,d){if(""===d.CharacteristicName)return!0;var e=[];$.each(d.BatchCharacteristicsValueSet.results,function(a,b){e.push({Value:b.Key})});var f={DeliveryLineID:a.getProperty("/CurrentDeliveryLineID"),CharacteristicName:d.CharacteristicName,Operation:d.Operation,BatchCharacteristicsValueSet:e,CopyFlag:d.CopyFlag?!0:!1},g=c.getView().getModel().createBatchOperation("/BatchCharacteristicsSet","POST",f);m.push(g)}),h.getSelected()&&$.each(i,function(a,b){if(b.selected!==!0)return!0;var d={DeliveryLineID:b.DeliveryLineID,DeliveryLineUpdateTime:com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(b.DeliveryLineUpdateTime,!0)},e=c.getView().getModel().createBatchOperation("/BatchCharacteristicsTargetSet","POST",d);m.push(e)}),0===m.length?(c.getView().getModel().setHeaders(null),c._refreshTable(),c._oMaintainBatchCharacteristicsDialog.close()):(this.getView().getModel().addBatchChangeOperations(m),this._oMaintainBatchCharacteristicsDialog.setBusy(!0),this.getView().getModel().submitBatch(function(a,b,d){var f=com.zespri.awct.util.NotificationHelper.handleErrorMessage(d);f||(e=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_MAINTAIN_BATCH_CHARACTERISTICS_SAVE_SUCCESS_TOAST"),com.zespri.awct.util.NotificationHelper.showSuccessToast(e)),c._oMaintainBatchCharacteristicsDialog.setBusy(!1),c._oMaintainBatchCharacteristicsDialog.close(),c.getView().getModel().setHeaders(null),c._refreshTable()},function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c.getView().getModel().setHeaders(null),c._oMaintainBatchCharacteristicsDialog.setBusy(!1),c._oMaintainBatchCharacteristicsDialog.close()}))},handleMaintainBatchCharacteristicsNameSelectChange:function(a){var b=this._oMaintainBatchCharacteristicsDialog.getModel("maintainBC"),c=this,d=a.getSource().getBindingContext("maintainBC").getPath().split("/"),e=parseInt(d[d.length-1],10);if(this._updateBatchCharacteristicsItemEnabled(),b.setProperty("/BatchCharacteristics/"+e+"/BatchCharacteristicsValueSet",{results:[]}),""!==a.getSource().getSelectedKey()){var f=b.getProperty("/BatchCharacteristics"),g=f.length,h=null;
if(e===g-1){var i=this._oMaintainBatchCharacteristicsDialog.getDomRef(),j=i.getElementsByTagName("section")[0];h=j.scrollHeight,f.push({BatchCharacteristicsID:"",BatchCharacteristicsValueSet:{results:[]},CharacteristicName:"",Operation:c._MaintainBCOperation.Include,BCNameSelected:!1})}var k=sap.ui.core.Fragment.byId("maintainBCDialog","maintainBCTable"),l=function(){if(c._oMaintainBatchCharacteristicsDialog.rerender(),h){var a=c._oMaintainBatchCharacteristicsDialog.getDomRef(),b=a.getElementsByTagName("section")[0];b.scrollTop=h}k.detachUpdateFinished(l)};k.attachUpdateFinished(l),b.setProperty("/BatchCharacteristics",f),b.setProperty("/BatchCharacteristics/"+e+"/BCNameSelected",!0)}else b.setProperty("/BatchCharacteristics/"+e+"/BCNameSelected",!1)},_updateBatchCharacteristicsItemEnabled:function(){var a=[],b=this._oMaintainBatchCharacteristicsDialog.getModel("maintainBC"),c=b.getProperty("/BatchCharacteristics");$.each(c,function(b,c){""!==c.CharacteristicName&&a.push(c.CharacteristicName)});var d=b.getProperty("/BatchCharacteristicsDomainValues");$.each(d,function(b,c){var d=!1;$.each(a,function(a,b){return c.BatchCharName===b?(d=!0,c.enabled=!1,!1):void 0}),d||(c.enabled=!0)}),b.setProperty("/BatchCharacteristicsDomainValues",null),b.setProperty("/BatchCharacteristicsDomainValues",d)},handleMaintainBatchCharacteristicsValueHelpLiveChange:function(a){var b=a.getParameter("value"),c=new sap.ui.model.Filter("Key",sap.ui.model.FilterOperator.StartsWith,b);this._oMaintainBatchCharacteristicsSearchHelpDialog.getBinding("items").filter(c)},handleMaintainBatchCharacteristicsValueHelpOpen:function(a){var b=this._oMaintainBatchCharacteristicsDialog.getModel("maintainBC");this._oMaintainBatchCharacteristicsSearchHelpDialog||(this._oMaintainBatchCharacteristicsSearchHelpDialog=sap.ui.xmlfragment("com.zespri.awct.alloc.fragment.EditAllocationsMaintainBatchCharacteristicsValuesF4",this),this._oMaintainBatchCharacteristicsSearchHelpDialog._oTable.setGrowing(!1),this._oMaintainBatchCharacteristicsSearchHelpDialog._dialog.setBusyIndicatorDelay(0));var c=com.zespri.awct.util.I18NHelper.getText("TXT_LIST_LOADING_LABEL");this._oMaintainBatchCharacteristicsSearchHelpDialog._table.setNoDataText(c);var d=this._oMaintainBatchCharacteristicsDialog.getModel("i18n");this._oMaintainBatchCharacteristicsSearchHelpDialog.setModel(d,"i18n"),this._oMaintainBatchCharacteristicsSearchHelpDialog.setModel(b,"maintainBC"),this._oMaintainBatchCharacteristicsSearchHelpDialog.open(),this._oMaintainBatchCharacteristicsSearchHelpDialog.getBinding("items").filter(null);var e=this;this._oMaintainBatchCharacteristicsSearchHelpDialog._dialog.setBusy(!0);var f=a.getSource().getBindingContext("maintainBC").getProperty("CharacteristicName");this.getView().getModel().read("/GenericSearchSet",{urlParameters:{$filter:"Scenario eq '"+f+"'"},success:function(a){var c=a.results;c.length||e._oMaintainBatchCharacteristicsSearchHelpDialog._table.setNoDataText(com.zespri.awct.util.I18NHelper.getText("TXT_LIST_NO_ITEMS_LABEL"));var d=b.getProperty("/BatchCharacteristics");jQuery.each(d,function(a,b){var d=b.BatchCharacteristicsValueSet.results;b.CharacteristicName===f&&jQuery.each(d,function(a,b){$.each(c,function(a,c){return b.Value===c.Key?(c.selected=!0,!1):void 0})})}),b.setProperty("/SearchHelpValues",c),b.setProperty("/SearchHelpBCName",f),e._oMaintainBatchCharacteristicsSearchHelpDialog._dialog.setBusy(!1)}})},handleMaintainBatchCharacteristicsValueHelpConfirm:function(a){var b=this._oMaintainBatchCharacteristicsDialog.getModel("maintainBC"),c=b.getProperty("/BatchCharacteristics"),d=b.getProperty("/SearchHelpBCName"),e;$.each(c,function(a,b){return b.CharacteristicName===d?(e=a,!1):void 0});var f=a.getParameter("selectedContexts"),g=[];$.each(f,function(a,b){g.push({Key:b.getProperty("Key"),Value:b.getProperty("Key")})}),b.setProperty("/BatchCharacteristics/"+e+"/BatchCharacteristicsValueSet",{results:g}),g.length>0&&b.setProperty("/BatchCharacteristics/"+e+"/error",!1)},handleMaintainBatchCharacteristicsPropagateLinesValueHelpOpen:function(){var a=this._oMaintainBatchCharacteristicsDialog.getModel("maintainBC"),b=this.getView().getModel(),c=a.getProperty("/CurrentDeliveryLineNumber"),d=a.getProperty("/CurrentDeliveryHeaderID"),e=this;this._oMaintainBatchCharacteristicsPropagateToLinesDialog||(this._oMaintainBatchCharacteristicsPropagateToLinesDialog=sap.ui.xmlfragment("maintainBCPropagateDialog","com.zespri.awct.alloc.fragment.EditAllocationsMaintainBatchCharacteristicsPropagate",this),this._oMaintainBatchCharacteristicsPropagateToLinesDialog._oTable.setGrowing(!1),this._oMaintainBatchCharacteristicsPropagateToLinesDialog._dialog.setBusyIndicatorDelay(0)),this._oMaintainBatchCharacteristicsPropagateToLinesDialog._table.setNoDataText(com.zespri.awct.util.I18NHelper.getText("TXT_LIST_LOADING_LABEL"));var f=this._oMaintainBatchCharacteristicsDialog.getModel("i18n");this._oMaintainBatchCharacteristicsPropagateToLinesDialog.setModel(f,"i18n"),this._oMaintainBatchCharacteristicsPropagateToLinesDialog.setModel(a,"maintainBC"),this._oMaintainBatchCharacteristicsPropagateToLinesDialog.open(),this._oMaintainBatchCharacteristicsPropagateToLinesDialog.getBinding("items").filter(null);var g=a.getProperty("/PropagateToLines");g?g.length||this._oMaintainBatchCharacteristicsPropagateToLinesDialog._table.setNoDataText(com.zespri.awct.util.I18NHelper.getText("TXT_LIST_NO_ITEMS_LABEL")):(this._oMaintainBatchCharacteristicsPropagateToLinesDialog._dialog.setBusy(!0),b.read("/GetDistinctDeliveryLineDetails",{urlParameters:{DeliveryNumber:"'"+d+"'",ExcludeDeliveryLineNumber:"'"+c+"'"},success:function(b){var c=b.results;c.length||e._oMaintainBatchCharacteristicsPropagateToLinesDialog._table.setNoDataText(com.zespri.awct.util.I18NHelper.getText("TXT_LIST_NO_ITEMS_LABEL")),a.setProperty("/PropagateToLines",c),e._oMaintainBatchCharacteristicsPropagateToLinesDialog._dialog.setBusy(!1)},error:function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),e._oMaintainBatchCharacteristicsPropagateToLinesDialog._dialog.setBusy(!1),e._oMaintainBatchCharacteristicsPropagateToLinesDialog._table.removeAllCustomData()}}))},handleMaintainBatchCharacteristicsPropagateLinesValueHelpConfirm:function(a){var b=this._oMaintainBatchCharacteristicsDialog.getModel("maintainBC"),c=a.getParameter("selectedContexts"),d=b.getProperty("/PropagateToLines");$.each(d,function(a,b){var d=!1;$.each(c,function(a,c){c.getProperty("DeliveryAllocationID")===b.DeliveryAllocationID&&(d=!0,b.selected=!0)}),d||(b.selected=!1)}),b.setProperty("/PropagateToLines",null),b.setProperty("/PropagateToLines",d)},handleMaintainBatchCharacteristicsPropagateLinesValueHelpLiveChange:function(a){var b=a.getParameter("value"),c=new sap.ui.model.Filter("DeliveryLineNumber",sap.ui.model.FilterOperator.StartsWith,b),d=new sap.ui.model.Filter("MaterialNumber",sap.ui.model.FilterOperator.StartsWith,b),e=new sap.ui.model.Filter("Brand",sap.ui.model.FilterOperator.StartsWith,b),f=new sap.ui.model.Filter("FruitGroup",sap.ui.model.FilterOperator.StartsWith,b),g=new sap.ui.model.Filter("Size",sap.ui.model.FilterOperator.StartsWith,b),h=new sap.ui.model.Filter("Pack",sap.ui.model.FilterOperator.StartsWith,b),i=new sap.ui.model.Filter("Label",sap.ui.model.FilterOperator.StartsWith,b),j=new sap.ui.model.Filter([c,d,e,f,g,h,i],!1);this._oMaintainBatchCharacteristicsPropagateToLinesDialog.getBinding("items").filter(j)},formatBatchCharacteristicsValues:function(a){var b=function(a){return a.Key};return a.results.map(b).join(", ")},formatBatchCharacteristicsValuesValueState:function(a){return a?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.None},formatBatchCharacteristicsPropagateToLinesText:function(a){if(!a)return"";var b=[];return $.each(a,function(a,c){c.selected&&b.push(c.DeliveryLineNumber)}),b.join(", ")},_triggerMacroSimulation:function(a){if(!this._stopActionIfViewDirty()){var b=this,c,d=function(){if(a===b._AllocationMacro.ProRata)c="SetProRataMacro";else{if(a!==b._AllocationMacro.Zero)return void jQuery.sap.log.error("Unsupported macro '"+a+"'");c="SetZeroMacro"}b.getView().getModel().read("/"+c,{urlParameters:{DeliveryNumber:"'"+b._oDeliveryHeaderContext.getProperty("DeliveryHeaderID")+"'"},success:function(c){var d=c.results;b._applyMacroSimulationResults(a,d)},error:function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a)}})};this._bSimulatingMacro=!0,this._mMacroSimulationTargets={};var e=this.getView().byId("allocationTable");e.attachEventOnce("updateFinished",d),this._oBusyDialog.open(),e.setGrowing(!1),this._refreshTable()}},_applyMacroSimulationResults:function(a,b){var c=this;$.each(b,function(a,b){var d=b.DeliveryAllocationID,e=b.Quantity,f=c._mMacroSimulationTargets[d];f&&(f.setValue(e),f.fireChange())}),this._mMacroSimulationTargets={},this._bSimulatingMacro=!1;var d=this.getView().byId("allocationTable");d.setGrowing(!0),this._oBusyDialog.close();var e;e=com.zespri.awct.util.I18NHelper.getText(a===c._AllocationMacro.ProRata?"TXT_ALLOCATION_EDITALLOCATIONS_PRO_RATA_MACRO_APPLIED_TOAST":"TXT_ALLOCATION_EDITALLOCATIONS_ZERO_MACRO_APPLIED_TOAST"),com.zespri.awct.util.NotificationHelper.showSuccessToast(e)},handleProRataMacroButtonPress:function(){this._triggerMacroSimulation(this._AllocationMacro.ProRata)},handleZeroMacroButtonPress:function(){this._triggerMacroSimulation(this._AllocationMacro.Zero)},handleMacrosButtonPress:function(){if(this._oMacrosActionSheet||(this._oMacrosActionSheet=new sap.ui.xmlfragment("com.zespri.awct.alloc.fragment.EditAllocationsMacrosActionSheet",this),this.getView().addDependent(this._oMacrosActionSheet)),this._oMacrosActionSheet.isOpen())this._oMacrosActionSheet.close();else{var a=this.byId("macrosButton");this._oMacrosActionSheet.openBy(a)}},handleMarketInfoOpen:function(){this._oMarketInfoDialog||(this._oMarketInfoDialog=new sap.ui.xmlfragment("marketInfoFragment","com.zespri.awct.alloc.fragment.EditAllocationsMarketInfoDialog",this),this.getView().addDependent(this._oMarketInfoDialog)),this._oMarketInfoDialog.setBindingContext(this._oDeliveryHeaderContext),this._oMarketInfoDialog.open()},handleMarketInfoClose:function(){this._oMarketInfoDialog.close()},formatMarketInfoText:function(a){return a?(sap.ui.core.Fragment.byId("marketInfoFragment","marketInfoText").removeStyleClass("zAwctTextGrayItalics"),a):(sap.ui.core.Fragment.byId("marketInfoFragment","marketInfoText").addStyleClass("zAwctTextGrayItalics"),com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_NO_MARKET_INFO_TEXT"))},handleViewDirtyStateChanged:function(a){a?(this.byId("saveButton").setEnabled(!0),this.byId("discardChangesButton").setEnabled(!0)):(this.byId("saveButton").setEnabled(!1),this.byId("discardChangesButton").setEnabled(!1))},handleObjectHeaderTitlePress:function(){var a=this.byId("deliveryObjectHeader"),b=a.getCondensed();a.setCondensed(!b)},handleFacetFilterReset:function(){if(!this._stopActionIfViewDirty()){var a=this.byId("facetFilterAllocation"),b=a.getLists();jQuery.each(b,function(a,b){b.setSelectedKeys()}),this._refreshTable()}},_refreshDeliveryHeaderContext:function(){this._setViewBusy(!0);var a=this,b="/DeliveryHeaderSet('"+this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID")+"')";this.getView().getModel().read(b,{urlParameters:{$select:"Status"},success:function(b){a._oDeliveryHeaderContext.getObject().Status=b.Status,a._updateFooter(),a._setViewBusy(!1),a._updateQuantityInputsEnabledState()}})},_updateQuantityInputsEnabledState:function(){this._oDeliveryHeaderContext.getProperty("Status")===com.zespri.awct.util.Enums.DeliveryStatus.Released?this._oViewStateModel.setProperty("/allowAllocationChange",!1):this._oViewStateModel.setProperty("/allowAllocationChange",!0)},_updateFooter:function(){var a=this._oDeliveryHeaderContext.getProperty("Status"),b=this.byId("releaseButton"),c=this.byId("lockButton"),d=this.byId("unlockButton"),e=this.byId("saveButton"),f=this.byId("discardChangesButton"),g=this.byId("macrosButton"),h=this.byId("addSuppliersToContainerButton");if(b.setVisible(!1),c.setVisible(!1),d.setVisible(!1),e.setVisible(!1),f.setVisible(!1),g.setVisible(!1),h.setVisible(!1),com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Maintain,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)){switch(a){case com.zespri.awct.util.Enums.DeliveryStatus.NotStarted:b.setVisible(!0),e.setVisible(!0),f.setVisible(!0),h.setVisible(!0);break;case com.zespri.awct.util.Enums.DeliveryStatus.InProgress:b.setVisible(!0),e.setVisible(!0),f.setVisible(!0),g.setVisible(!0),h.setVisible(!0);break;case com.zespri.awct.util.Enums.DeliveryStatus.Released:c.setVisible(!0);break;case com.zespri.awct.util.Enums.DeliveryStatus.Locked:d.setVisible(!0),e.setVisible(!0),f.setVisible(!0),g.setVisible(!0),h.setVisible(!0)}this._oDeliveryHeaderContext.getProperty("ContainerOrCharter")!==this._ShipmentType.Container&&h.setVisible(!1)}},_refreshTable:function(){jQuery.sap.assert(!this.getHasUnsavedChanges(),"_refreshTable was called even though view is dirty!"),jQuery.sap.assert(this._oDeliveryHeaderContext,"_refreshTable was called, but delivery header context is not available!"),jQuery.sap.assert(this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID"),"_refreshTable was called, but key DeliveryHeaderID is not available in delivery header context!");var a=this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID"),b=new sap.ui.model.Filter("DeliveryHeaderID","EQ",a),c=this.byId("facetFilterAllocation").getLists(),d=[],e=[];$.each(c,function(a,b){if(b.getSelectedItems().length>0){var c=[];$.each(b.getSelectedItems(),function(a,d){c.push(new sap.ui.model.Filter(b.getKey(),"EQ",d.getKey()))}),d.push(new sap.ui.model.Filter(c,!1))}}),e.push(b),d.length>0&&e.push(new sap.ui.model.Filter(d,!0));var f=[];this._oDeliveryHeaderContext.getProperty("ContainerOrCharter")===this._ShipmentType.Charter?f.push(new sap.ui.model.Sorter("DeliveryLineID",!1)):(f.push(new sap.ui.model.Sorter("ContainerID",!1)),f.push(new sap.ui.model.Sorter("DeliveryLineID",!1)));var g=this.byId("allocationTable"),h={path:"/AllocationLineSet",sorter:f,factory:jQuery.proxy(this.createTableColumnListItem,this),filters:e};g.bindItems(h)},handleNavigationWithUnsavedChanges:function(a){var b=a.getParameter("fnAllowNavigation"),c=this,d=function(){c.setHasUnsavedChanges(!1),b()},e=com.zespri.awct.util.I18NHelper.getText("TXT_GENERIC_NAVIGATION_DATA_LOSS_MESSAGE");com.zespri.awct.util.NotificationHelper.showConfirmDialog(e,d)},handleAddSupplierInputValueChange:function(a){a.getSource().setValueState(isNaN(a.getSource().getValue())?""===a.getSource().getValue()?sap.ui.core.ValueState.None:sap.ui.core.ValueState.Error:parseFloat(a.getSource().getValue())<0?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.None)},handleAddSupplierClose:function(){this._oDialogAddSupplier.close()},handleAddSupplierSearch:function(a){var b=a.getParameter("newValue"),c=new sap.ui.model.Filter("Supplier",sap.ui.model.FilterOperator.Contains,b),d=sap.ui.core.Fragment.byId("addSupplierDialog","addSupplierTable").getBinding("items");d.filter([c])},handleAddSuppliersConfirm:function(){var a=this,b=[],c=sap.ui.core.Fragment.byId("addSupplierDialog","addSupplierTable").getItems(),d=!1;c.length&&c.map(function(a){a.getCells()[1].getContent()[0].getValueState()===sap.ui.core.ValueState.Error&&(d=!0)}),d?com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_ADDSUPPLIER_INVALID_ENTRY")):(this._oDeliveryHeaderContext.getProperty("Status")===com.zespri.awct.util.Enums.DeliveryStatus.Locked&&this.getView().getModel().setHeaders({"REL2-RELEVANT":sap.ui.core.Fragment.byId("addSupplierDialog","supplierRel2RelevantCheckbox").getSelected()}),c.map(function(c){var d=parseFloat(c.getCells()[1].getContent()[0].getValue());if(!isNaN(d)&&d>0){var e={};a._oDialogAddSupplier.setBusy(!0),e.DeliveryLineNumber=c.getBindingContext("addSuppliersModel").getProperty("/DeliveryLineNumber"),e.DeliveryHeaderID=c.getBindingContext("addSuppliersModel").getProperty("/DeliveryHeaderID"),e.DeliveryLineID=c.getBindingContext("addSuppliersModel").getProperty("/DeliveryLineID"),e.SupplierID=c.getBindingContext("addSuppliersModel").getProperty("Supplier"),e.AllocationQuantity=d+"",e.DeliveryLineUpdateTime=com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getBindingContext("addSuppliersModel").getProperty("/DeliveryLineUpdateTime"),!0),b.push(a.getView().getModel().createBatchOperation("AllocationLineSet","POST",e))}}),a.getView().getModel().addBatchChangeOperations(b),b.length?(a._oDialogAddSupplier.setBusy(!0),a.getView().getModel().submitBatch(function(b,c,d){a.getView().getModel().setHeaders(null);var e=com.zespri.awct.util.NotificationHelper.handleErrorMessage(d);a._setViewBusy(!0),a._refreshDeliveryHeaderContext(),a._oDialogAddSupplier.setBusy(!1),e||(a._oDialogAddSupplier.close(),com.zespri.awct.util.NotificationHelper.showSuccessToast(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_ADDSUPPLIER_CREATE_SUCCESS"))),a._refreshTable()},function(b){a.getView().getModel().setHeaders(null),com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._oDialogAddSupplier.setBusy(!1)})):com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_ADDSUPPLIER_NO_QUANTITY_ERROR_TOAST")))},_stopActionIfViewDirty:function(){if(this.getHasUnsavedChanges()){var a=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_SAVE_CHANGES_FIRST_TOAST");return com.zespri.awct.util.NotificationHelper.showErrorToast(a),!0}return!1},_initFacetFilterLists:function(){jQuery.sap.assert(this._oDeliveryHeaderContext,"_initFacetFilterLists() was called even though delivery header context is not yet available!");var a=this.byId("facetFilterAllocation"),b=this.byId("containerFacetList");this._oDeliveryHeaderContext.getProperty("ContainerOrCharter")===this._ShipmentType.Charter&&(a.removeList(b),b.destroyItems());var c=this.byId("containerTypeFacetList");if(this._oDeliveryHeaderContext.getProperty("ContainerOrCharter")===this._ShipmentType.Charter)a.removeList(c),c.destroyItems();else{var d=new sap.ui.model.json.JSONModel({values:[{ContainerType:"20"},{ContainerType:"40"}]});c.setModel(d),c.bindItems({path:"/values",template:c.getBindingInfo("items")?c.getBindingInfo("items").template:c.getItems()[0].clone()})}},handleFacetListOpen:function(a){var b=a.getSource().getKey(),c={},d=this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID");switch(b){case"ContainerID":c.facetListControl=this.byId("containerFacetList"),c.entitySetName="ContainerSet",c.filterString="DeliveryID eq '"+d+"'",c.selectString="ContainerID",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(c,!1);break;case"SupplierID":c.facetListControl=this.byId("supplierFacetList"),c.entitySetName="GetLinkedSuppliersForDelivery",c.urlParameter={DeliveryID:"'"+d+"'"},com.zespri.awct.util.CommonHelper.createFacetFilterListItems(c,!1);break;case"MaterialNumber":c.facetListControl=this.byId("materialFacetList"),c.entitySetName="GetLinkedMaterialsForDelivery",c.urlParameter={DeliveryID:"'"+d+"'"},com.zespri.awct.util.CommonHelper.createFacetFilterListItems(c,!1)}},_initTableConfiguration:function(){var a=this.byId("allocationTable");this._oDeliveryHeaderContext.getProperty("ContainerOrCharter")===this._ShipmentType.Charter&&(a.removeColumn(this.byId("containerIDColumn")),this.byId("containerIDColumn").destroy(),a.removeColumn(this.byId("containerTypeColumn")),this.byId("containerTypeColumn").destroy())},handleDeliveryReleaseDialogOpen:function(){var a=this;if(!this._stopActionIfViewDirty()){if(!this._oReleaseDeliveryDialog){this._oReleaseDeliveryDialog=new sap.ui.xmlfragment("releaseDeliveryDialog","com.zespri.awct.alloc.fragment.EditAllocationsReleaseDialog",this),this.getView().addDependent(this._oReleaseDeliveryDialog);var b=sap.ui.core.Fragment.byId("releaseDeliveryDialog","chargeCodeTable");com.zespri.awct.util.CommonHelper.manageNoDataText(b),b.attachUpdateFinished(function(){a._oReleaseDeliveryDialog.rerender()})}var c=this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID");sap.ui.core.Fragment.byId("releaseDeliveryDialog","commentTextArea").setValue(""),sap.ui.core.Fragment.byId("releaseDeliveryDialog","releaseReasonSelect").getSelectedKey(""),this._setViewBusy(!0),this.getView().getModel().read("/GetAdditionalDeliveryInfo",{urlParameters:{DeliveryID:"'"+c+"'"},success:function(b){var d=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_RELEASE_DIALOG_DEMAND_GT_SUPPLY_NODATA_TEXT"),e=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_RELEASE_DIALOG_BC_NOT_MAINTAINED_NODATA_TEXT");sap.ui.core.Fragment.byId("releaseDeliveryDialog","demandGTSupplyText").setText(d).addStyleClass("zAwctTextGrayItalics"),sap.ui.core.Fragment.byId("releaseDeliveryDialog","batchCharNTMaintText").setText(e).addStyleClass("zAwctTextGrayItalics"),sap.ui.core.Fragment.byId("releaseDeliveryDialog","shipmentNumberText").setText(a._oDeliveryHeaderContext.getProperty("ShipmentID")),sap.ui.core.Fragment.byId("releaseDeliveryDialog","deliveryNumberText").setText(a._oDeliveryHeaderContext.getProperty("DeliveryHeaderID"));for(var f=b.results.length,g=0;f>g;g++)b.results[g].Key===a._DeliveryAdditionalInfoKey.DemandGTSupply?sap.ui.core.Fragment.byId("releaseDeliveryDialog","demandGTSupplyText").setText(b.results[g].Value).removeStyleClass("zAwctTextGrayItalics"):b.results[g].Key===a._DeliveryAdditionalInfoKey.BCNotMaintained&&sap.ui.core.Fragment.byId("releaseDeliveryDialog","batchCharNTMaintText").setText(b.results[g].Value).removeStyleClass("zAwctTextGrayItalics");com.zespri.awct.util.ModelHelper.getJSONModelForRead("/GetChargeCodesForRelease",{urlParameters:{DeliveryID:"'"+c+"'"}},function(b){a._setViewBusy(!1);var c=sap.ui.core.Fragment.byId("releaseDeliveryDialog","chargeCodeTable");c.setModel(b),c.bindItems({path:"/results",factory:jQuery.proxy(a._createReleaseChargeCodeTableColumnListItem,a)})},function(b){a._oReleaseDeliveryDialog.close(),com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._setViewBusy(!1)}),a._oReleaseDeliveryDialog.open()},error:function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._setViewBusy(!1)}})}},_createReleaseChargeCodeTableColumnListItem:function(a,b){var c=b.getProperty("ChargeCode"),d;if(d=c===this._ChargeCodes.NonChargeTotal||c===this._ChargeCodes.NonChargeSubTotal?sap.ui.xmlfragment(a,"com.zespri.awct.alloc.fragment.EditAllocationsChargeCodeTableTemplate",this).addStyleClass("zAwctChargeCodeTableRowStyling"):sap.ui.xmlfragment(a,"com.zespri.awct.alloc.fragment.EditAllocationsChargeCodeTableTemplate",this),c===this._ChargeCodes.NonChargeSubTotal)sap.ui.core.Fragment.byId(a,"quantityText").setText(""),sap.ui.core.Fragment.byId(a,"rateText").setText(""),sap.ui.core.Fragment.byId(a,"deliveryNumberText").setText(""),sap.ui.core.Fragment.byId(a,"chargeCodeText").setText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_CHARGE_CODE_TABLE_NCS_CHARGE_CODE_TEXT"));else{var e=com.zespri.awct.util.LocaleFormatHelper.formatQuantity(b.getProperty("Quantity")),f=com.zespri.awct.util.LocaleFormatHelper.formatAmount(b.getProperty("Rate"),b.getProperty("Currency"));sap.ui.core.Fragment.byId(a,"rateText").setText(f),sap.ui.core.Fragment.byId(a,"chargeCodeText").setText(c),c!==this._ChargeCodes.AdministrativeCharges&&(sap.ui.core.Fragment.byId(a,"deliveryNumberText").setText(b.getProperty("DeliveryLineNumber")),sap.ui.core.Fragment.byId(a,"quantityText").setText(e+" "+b.getProperty("UoM")))}return d},_createUnlockChargeCodeTableColumnListItem:function(a,b){var c=b.getProperty("ChargeCode"),d;if(d=c===this._ChargeCodes.NonChargeTotal||c===this._ChargeCodes.NonChargeSubTotal?sap.ui.xmlfragment(a,"com.zespri.awct.alloc.fragment.EditAllocationsChargeCodeTableTemplate",this).addStyleClass("zAwctChargeCodeTableRowStyling"):sap.ui.xmlfragment(a,"com.zespri.awct.alloc.fragment.EditAllocationsChargeCodeTableTemplate",this),c===this._ChargeCodes.NonChargeTotal)sap.ui.core.Fragment.byId(a,"quantityText").setText(""),sap.ui.core.Fragment.byId(a,"rateText").setText(""),sap.ui.core.Fragment.byId(a,"deliveryNumberText").setText(""),sap.ui.core.Fragment.byId(a,"chargeCodeText").setText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_CHARGE_CODE_TABLE_NCT_CHARGE_CODE_TEXT"));else if(c===this._ChargeCodes.NonChargeSubTotal)sap.ui.core.Fragment.byId(a,"quantityText").setText(""),sap.ui.core.Fragment.byId(a,"rateText").setText(""),sap.ui.core.Fragment.byId(a,"deliveryNumberText").setText(""),sap.ui.core.Fragment.byId(a,"chargeCodeText").setText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_CHARGE_CODE_TABLE_NCS_EXCLUDING_CHARGE_CODE_TEXT"));else{var e=com.zespri.awct.util.LocaleFormatHelper.formatQuantity(b.getProperty("Quantity")),f=com.zespri.awct.util.LocaleFormatHelper.formatAmount(b.getProperty("Rate"),b.getProperty("Currency"));sap.ui.core.Fragment.byId(a,"rateText").setText(f),sap.ui.core.Fragment.byId(a,"chargeCodeText").setText(c),c!==this._ChargeCodes.AdministrativeCharges&&(sap.ui.core.Fragment.byId(a,"quantityText").setText(e+" "+b.getProperty("UoM")),sap.ui.core.Fragment.byId(a,"deliveryNumberText").setText(b.getProperty("DeliveryLineNumber")))}return d},handleDeliveryRelease:function(){var a=this,b=this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID"),c=sap.ui.core.Fragment.byId("releaseDeliveryDialog","commentTextArea").getValue(),d=sap.ui.core.Fragment.byId("releaseDeliveryDialog","releaseReasonSelect").getSelectedKey();this._oReleaseDeliveryDialog.setBusy(!0),this.getView().getModel().read("/ReleaseDelivery",{urlParameters:{DeliveryID:"'"+b+"'",Comment:"'"+c+"'",Reason:"'"+d+"'"},success:function(){var c=a._oDeliveryHeaderContext.getPath().substr(1);if(a._oDeliveryHeaderContext.getModel()!==a.getView().getModel()){var d=a._oDeliveryHeaderContext.getModel().getData().result,e=d.__metadata.uri,f=e.split("/");f.length&&(c=f[f.length-1])}a._oReleaseDeliveryDialog.setBusy(!1),a._oReleaseDeliveryDialog.close(),a.getRouter().navTo("Allocation/DeliveryWorkList/Detail",{contextPath:c}),window.setTimeout(function(){var a=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_RELEASE_DELIVERY_SUCCESS",[b]);com.zespri.awct.util.NotificationHelper.showSuccessToast(a)},500)},error:function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._oReleaseDeliveryDialog.setBusy(!1)}})},handleDeliveryReleaseCancel:function(){this._oReleaseDeliveryDialog.close()},handleDeliveryUnLockPress:function(){var a=this;if(!this._stopActionIfViewDirty()){if(!this._oUnlockDeliveryDialog){this._oUnlockDeliveryDialog=new sap.ui.xmlfragment("unlockDeliveryFragment","com.zespri.awct.alloc.fragment.EditAllocationsUnlockDialog",this),this.getView().addDependent(this._oUnlockDeliveryDialog);var b=sap.ui.core.Fragment.byId("unlockDeliveryFragment","chargeCodeTable");com.zespri.awct.util.CommonHelper.manageNoDataText(b),b.attachUpdateFinished(function(){a._oUnlockDeliveryDialog.rerender()})}var c=this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID");sap.ui.core.Fragment.byId("unlockDeliveryFragment","selectDemandChangeReason").getSelectedKey(""),this._setViewBusy(!0),this.getView().getModel().read("/GetAdditionalDeliveryInfo",{urlParameters:{DeliveryID:"'"+c+"'"},success:function(b){var d=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_UNLOCK_DIALOG_DEMAND_GT_SUPPLY_NODATA_TEXT"),e=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_UNLOCK_DIALOG_BC_NOT_MAINTAINED_NODATA_TEXT");sap.ui.core.Fragment.byId("unlockDeliveryFragment","demandGTSupplyText").setText(d).addStyleClass("zAwctTextGrayItalics"),sap.ui.core.Fragment.byId("unlockDeliveryFragment","batchCharNTMaintText").setText(e).addStyleClass("zAwctTextGrayItalics"),sap.ui.core.Fragment.byId("unlockDeliveryFragment","shipmentNumberText").setText(a._oDeliveryHeaderContext.getProperty("ShipmentID")),sap.ui.core.Fragment.byId("unlockDeliveryFragment","deliveryNumberText").setText(a._oDeliveryHeaderContext.getProperty("DeliveryHeaderID"));for(var f=b.results.length,g=0;f>g;g++)b.results[g].Key===a._DeliveryAdditionalInfoKey.DemandGTSupply?sap.ui.core.Fragment.byId("unlockDeliveryFragment","demandGTSupplyText").setText(b.results[g].Value).removeStyleClass("zAwctTextGrayItalics"):b.results[g].Key===a._DeliveryAdditionalInfoKey.BCNotMaintained&&sap.ui.core.Fragment.byId("unlockDeliveryFragment","batchCharNTMaintText").setText(b.results[g].Value).removeStyleClass("zAwctTextGrayItalics");com.zespri.awct.util.ModelHelper.getJSONModelForRead("/GetChargeCodesForUnlock",{urlParameters:{DeliveryID:"'"+c+"'"}},function(b){a._setViewBusy(!1);var c=sap.ui.core.Fragment.byId("unlockDeliveryFragment","chargeCodeTable");c.setModel(b),c.bindItems({path:"/results",factory:jQuery.proxy(a._createUnlockChargeCodeTableColumnListItem,a)})},function(b){a._oUnlockDeliveryDialog.close(),com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._setViewBusy(!1)}),a._oUnlockDeliveryDialog.open()},error:function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._setViewBusy(!1)}})}},handleUnlockContinuePress:function(){var a=this,b=this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID");this._sReason=sap.ui.core.Fragment.byId("unlockDeliveryFragment","selectDemandChangeReason").getSelectedKey(),this._oUnlockDeliveryDialog.setBusy(!0),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/UnlockDelivery",{urlParameters:{DeliveryID:"'"+b+"'",Reason:"'"+this._sReason+"'",Confirm:!1}},function(){a._oUnlockDeliveryDialog.setBusy(!1),a._oUnlockDeliveryDialog.close();var c=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_UNLOCK_DELIVERY_SUCCESS",[b]);com.zespri.awct.util.NotificationHelper.showSuccessToast(c),a._refreshDeliveryHeaderContext()},function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._oUnlockDeliveryDialog.setBusy(!1)})},handleUnlockCancelPress:function(){this._oUnlockDeliveryDialog.close()},handleDeliveryLockPress:function(){if(!this._stopActionIfViewDirty()){this._setViewBusy(!0);var a=this,b=this._oDeliveryHeaderContext.getProperty("DeliveryHeaderID");this.getView().getModel().read("/LockDelivery",{urlParameters:{DeliveryID:"'"+b+"'"},success:function(){var b=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_LOCK_SUCCESS");com.zespri.awct.util.NotificationHelper.showSuccessToast(b),a._refreshDeliveryHeaderContext()},error:function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._setViewBusy(!1)}})}},handleAddSuppliersToContainerOpen:function(){var a=this;this._oAddSuppliersToContainerDialog||(this._oAddSuppliersToContainerDialog=new sap.ui.xmlfragment("addSuppliersToContainerFragment","com.zespri.awct.alloc.fragment.AddSuppliersToContainer",this),this.getView().addDependent(this._oAddSuppliersToContainerDialog));var b=sap.ui.core.Fragment.byId("addSuppliersToContainerFragment","supplierIDInput");b.setValue(""),this._getCustomDataForKey(b,"supplierList")&&b.removeCustomData(this._getCustomDataForKey(b,"supplierList")),this._oAddSuppliersToContainerDialog.setBindingContext(this._oDeliveryHeaderContext),this._oAddSuppliersToContainerDialog.setBusy(!0),this._oAddSuppliersToContainerDialog.open(),com.zespri.awct.util.ModelHelper.getJSONModelForRead("ContainerSet",{urlParameters:{$filter:"DeliveryID eq '"+a._oDeliveryHeaderContext.getProperty("DeliveryHeaderID")+"'"}},function(b){var c=sap.ui.core.Fragment.byId("addSuppliersToContainerFragment","containerSelect");c.setModel(b),c.bindItems({path:"/results",template:c.getBindingInfo("items")?c.getBindingInfo("items").template:c.getItems()[0].clone()}),a._oAddSuppliersToContainerDialog.setBusy(!1)},function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a._oAddSuppliersToContainerDialog.setBusy(!1),a._oAddSuppliersToContainerDialog.close()
})},handleAddSuppliersToContainerCancelPress:function(){this._oAddSuppliersToContainerDialog.close()},handleValueHelpPress:function(a){this._oAddSuppliersToContainerSearchInputField=a.getSource(),this._oAddSuppliersToContainerSearchHelpDialog||(this._oAddSuppliersToContainerSearchHelpDialog=new sap.ui.xmlfragment("supplierListDialog","com.zespri.awct.collab.fragment.SearchFieldSelectionDialog",this),this.getView().addDependent(this._oAddSuppliersToContainerSearchHelpDialog)),this._oAddSuppliersToContainerSearchHelpDialog.setTitle(this._getCustomDataForKey(this._oAddSuppliersToContainerSearchInputField,"label").getValue()),com.zespri.awct.util.CommonHelper.manageNoDataText(this._oAddSuppliersToContainerSearchHelpDialog._table),this.bindTableSelectDialog(this._oAddSuppliersToContainerSearchInputField)},_getCustomDataForKey:function(a,b){var c=a.getCustomData();if(c.length)for(var d=0;d<c.length;d++)if(c[d].getKey()===b)return c[d];return""},bindTableSelectDialog:function(a){var b=this.getView(),c=this,d=c._getCustomDataForKey(a,"entitySet").getValue(),e=c._getCustomDataForKey(a,"filterKey").getValue();sap.ui.core.Fragment.byId("supplierListDialog","searchFieldLabel").setText(com.zespri.awct.util.I18NHelper.getText("TXT_COLLABORATION_SEARCH_FORM_VALUE_HELP_DIALOG_ALL_LABEL"));var f=function(b){c._oAddSuppliersToContainerSearchHelpDialog.setGrowingThreshold(b.getData().results.length),c._oAddSuppliersToContainerSearchHelpDialog.setModel(b);var d={path:"/results",factory:function(a,b){var c=b.getProperty(e);return new sap.m.ColumnListItem({cells:[new sap.m.Text({text:c})]})}};c._oAddSuppliersToContainerSearchHelpDialog.bindItems(d);for(var f=a.getValue().split(", "),g=0;g<f.length;g++)for(var h=0;h<c._oAddSuppliersToContainerSearchHelpDialog.getItems().length;h++)f[g]&&f[g]===c._oAddSuppliersToContainerSearchHelpDialog.getItems()[h].getCells()[0].getText()&&c._oAddSuppliersToContainerSearchHelpDialog.getItems()[h].setSelected(!0);c._oAddSuppliersToContainerSearchHelpDialog._dialog.setBusy(!1)};this._oAddSuppliersToContainerSearchHelpDialog.destroyItems(),this._oAddSuppliersToContainerSearchHelpDialog.open(),this._oAddSuppliersToContainerSearchHelpDialog._dialog.setBusy(!0),this._oAddSuppliersToContainerSearchHelpDialog._dialog.setBusyIndicatorDelay(0);var g=b.getModel("currentUserDetails").getProperty("/UserID");com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$select:"SupplierID",$filter:"UserID eq '"+g+"'"}},f,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oAddSuppliersToContainerSearchHelpDialog._dialog.setBusy(!1),c._oAddSuppliersToContainerSearchHelpDialog._dialog.close()})},handleValueHelpDialogSearch:function(a){var b=a.getParameter("value"),c=this.getView().getController()._getCustomDataForKey(this._oAddSuppliersToContainerSearchInputField,"filterKey").getValue(),d=new sap.ui.model.Filter(c,sap.ui.model.FilterOperator.Contains,b),e=a.getSource().getBinding("items");e.filter([d])},handleValueHelpDialogOKPress:function(a){var b=this._getCustomDataForKey(this._oAddSuppliersToContainerSearchInputField,"filterKey").getValue(),c=a.getParameter("selectedContexts"),d=c.map(function(a){return a.getProperty(b)});this._oAddSuppliersToContainerSearchInputField.setValue(d.join(", ")),this._getCustomDataForKey(this._oAddSuppliersToContainerSearchInputField,"supplierList")&&this._oAddSuppliersToContainerSearchInputField.removeCustomData(this._getCustomDataForKey(this._oAddSuppliersToContainerSearchInputField,"supplierList")),d.length>0&&this._oAddSuppliersToContainerSearchInputField.addCustomData(new sap.ui.core.CustomData({key:"supplierList",value:d}))},handleAddSuppliersToContainerOKPress:function(){var a=this,b=this._oAddSuppliersToContainerDialog.getBindingContext().getProperty("DeliveryHeaderID"),c=sap.ui.core.Fragment.byId("addSuppliersToContainerFragment","containerSelect").getSelectedKey(),d=sap.ui.core.Fragment.byId("addSuppliersToContainerFragment","supplierIDInput"),e=[];this._getCustomDataForKey(d,"supplierList")&&(e=this._getCustomDataForKey(d,"supplierList").getValue()),e.length&&c?(this._oAddSuppliersToContainerDialog.setBusy(!0),sap.ui.getCore().getRootComponent().getModel().read("/AddSuppliersToContainer",{urlParameters:{DeliveryNumber:"'"+b+"'",ContainerID:"'"+c+"'",SupplierList:"'"+e.join(",")+"'"},success:function(){a._oAddSuppliersToContainerDialog.setBusy(!1),a._oAddSuppliersToContainerDialog.close(),com.zespri.awct.util.NotificationHelper.showSuccessToast(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_ADDSUPPLIERSTOCONTAINER_SUCCESS_MESSAGE")),a.byId("allocationTable").getBinding("items").refresh()},error:function(b){a._oAddSuppliersToContainerDialog.setBusy(!1),com.zespri.awct.util.NotificationHelper.handleErrorMessage(b)}})):com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_EDITALLOCATIONS_ADDSUPPLIERSTOCONTAINER_ERROR_MESSAGE"))}})}();