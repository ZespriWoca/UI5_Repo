/*----------------------------------------------------------------------* 
 * Copyright  (c) 2014 SAP SE. All rights reserved	
 * Author       : SAP Custom Development 
 *----------------------------------------------------------------------*/ 
	!function(){"use strict";jQuery.sap.require({modName:"com.zespri.awct.core.Controller",type:"controller"}),jQuery.sap.require("com.zespri.awct.util.CommonHelper"),jQuery.sap.require("com.zespri.awct.util.Enums"),jQuery.sap.require("com.zespri.awct.util.I18NHelper"),jQuery.sap.require("com.zespri.awct.util.LocaleFormatHelper"),jQuery.sap.require("com.zespri.awct.util.ModelHelper"),jQuery.sap.require("com.zespri.awct.util.NotificationHelper"),com.zespri.awct.core.Controller.extend("com.zespri.awct.alloc.view.MasterDeliveryWorkList",{onInit:function(){this._bCustomFiltersApplied=!1,this._aCustomFilters=[],this._oViewSettingsDialog=null,this._bViewSettingsDialogChanged=null,this._aFiltersFromSettingsDialog=[],this._aSortersFromSettingsDialog=[],this._$deliveryWorkListReadPromise=null,this._$deliveryWorkListReadDeferred=null,this._bSelectFirstItem=!0,this._sRoutedDeliveryID="",this._bListItemClicked=!1,this._sLastRouteIDBeforeNoResults=null,this._oBusyDialog=new sap.m.BusyDialog,this._bUserAuthorized=!1,this._bWorkListLoadedFirstTime=!1,this._bShipmentNumberFiltered=!1,com.zespri.awct.util.CommonHelper.manageNoDataText(this._getList()),this._getList().attachUpdateFinished(this._onDataLoaded,this);var a=this.getView(),b=this;this.getRouter().attachRoutePatternMatched(function(c){var d=this._getList(),e=c.getParameter("name");if(-1!==e.indexOf("Allocation/DeliveryWorkList")){if(!b._bUserAuthorized)return void com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_USER_NOT_AUTHORIZED_MESSAGE_TEXT"));if(c.getParameter("arguments").customData){var f="",g=c.getParameter("arguments").customData.filters;g&&(g.Status&&(b.byId("deliveryWorkListSearch").setValue(""),b._bViewSettingsDialogChanged=!1,b._aCustomFilters=[],$.each(g.Status,function(a,c){b._aCustomFilters.push(new sap.ui.model.Filter("Status",sap.ui.model.FilterOperator.EQ,c))}),-1!==g.Status.indexOf(com.zespri.awct.util.Enums.DeliveryStatus.Released)&&-1!==g.Status.indexOf(com.zespri.awct.util.Enums.DeliveryStatus.Locked)?(f=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORLIST_MASTER_FILTERING_CUSTOM_DATA_STATUS_TEXT"),b._bCustomFiltersApplied=!0):-1!==g.Status.indexOf(com.zespri.awct.util.Enums.DeliveryStatus.Locked)&&(f=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORLIST_MASTER_FILTERING_CUSTOM_DATA_LOCKED_STATUS_TEXT"),b._bCustomFiltersApplied=!0)),void 0!==g.IsSupplyGtDemandFlag&&(f=f?f+", "+com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORLIST_MASTER_FILTERING_CUSTOM_DATA_SUPPLY_GT_DEMAND_TEXT"):com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORLIST_MASTER_FILTERING_CUSTOM_DATA_SUPPLY_GT_DEMAND_TEXT"),b._aCustomFilters.push(new sap.ui.model.Filter("IsSupplyGtDemandFlag",sap.ui.model.FilterOperator.EQ,g.IsSupplyGtDemandFlag)),b._bCustomFiltersApplied=!0),this._bindDeliveryList("/DeliveryHeaderSet",b._aCustomFilters,this._getDefaultSorter()),this._initialiseViewSettingsDialog(g),this.byId("deliveryListFilterBar").setVisible(!0),this.byId("deliveryListFilterBar").setVisible(!0),this.byId("deliveryListFilterBarLabel").setTooltip(f),this.byId("deliveryListFilterBarLabel").setText(f))}else d.getBinding("items")||(this._bindDeliveryList("/DeliveryHeaderSet",this._getDefaultFilter(),this._getDefaultSorter()),this._initialiseViewSettingsDialog(null),this.byId("deliveryListFilterBar").setVisible(!0),this.byId("deliveryListFilterBarLabel").setTooltip(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORLIST_MASTER_FILTERING_TEXT")),this.byId("deliveryListFilterBarLabel").setText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORLIST_MASTER_FILTERING_TEXT")))}if("Allocation/DeliveryWorkList"===c.getParameter("name")){if("routeChanged"===this._sLastRouteIDBeforeNoResults)return void history.back();this._bSelectFirstItem=!0,this._bListItemClicked=!0,this._bWorkListLoadedFirstTime=!0}else if("Allocation/DeliveryWorkList/Detail"===c.getParameter("name")){this._bWorkListLoadedFirstTime=!1,this._bListItemClicked||this._bSelectFirstItem||(this._$deliveryWorkListReadDeferred=null,this._$deliveryWorkListReadDeferred=jQuery.Deferred(),this._$deliveryWorkListReadPromise=this._$deliveryWorkListReadDeferred.promise(),this._oBusyDialog.open(),d.getBinding("items").refresh(!0));var h,i=jQuery.Deferred();h=i.promise(),this._bSelectFirstItem=!1;var j=new sap.ui.model.Context(a.getModel(),"/"+c.getParameter("arguments").contextPath);if(this._sRoutedDeliveryID=j.getProperty("DeliveryHeaderID"),this._sRoutedDeliveryID)jQuery.when(b._$deliveryWorkListReadPromise).done(function(){b._bListItemClicked?b._bListItemClicked=!1:b._updateViewBasedOnRoute(),b._oBusyDialog.close()});else{var k="/"+c.getParameter("arguments").contextPath,l=function(a){b._sRoutedDeliveryID=a.DeliveryHeaderID,i.resolve()},m=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a);var c=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_EMPTY_INFO_DELIVERY_TEXT"),d=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_EMPTY_VIEW_TITLE");b._navToEmptyView(d,c,!1),b._oBusyDialog.close()};this.getView().getModel().read(k,{success:l,error:m}),jQuery.when(b._$deliveryWorkListReadPromise,h).done(function(){b._updateViewBasedOnRoute()})}}else if("Allocation/DeliveryWorkList/NoResults"===c.getParameter("name")){this._bWorkListLoadedFirstTime=!1;var n=c.getParameter("arguments");if("true"===n.isEmptyView){if(d.getSelectedItem())return history.back(),void(this._sLastRouteIDBeforeNoResults="routeChanged")}else d.removeSelections(!0),this._sLastRouteIDBeforeNoResults=this._sRoutedDeliveryID}},this)},onBeforeRendering:function(){com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Display,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)?this._bUserAuthorized=!0:(this.byId("masterPage")&&this.byId("masterPage").destroy(),this._bUserAuthorized=!1)},_updateViewBasedOnRoute:function(){return this._sLastRouteIDBeforeNoResults===this._sRoutedDeliveryID?(history.back(),void(this._sLastRouteIDBeforeNoResults="routeChanged")):void this._selectListItemBasedOnRoute()},_selectListItemBasedOnRoute:function(){var a=this._getList(),b=this._getListItemFromMasterList(this._sRoutedDeliveryID,a);if(b){if(this._setSelectedListItem(b),b.getDomRef()&&jQuery.device.is.desktop){var c=b.getDomRef().offsetTop,d=a.getParent().getDomRef().getElementsByTagName("section")[0];d.scrollTop=c}}else{var e=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_EMPTY_INFO_DELIVERY_TEXT"),f=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_EMPTY_VIEW_TITLE");this._navToEmptyView(f,e,!1)}},_getList:function(){return this.getView().byId("deliveryList")},_getDefaultFilter:function(){var a=[],b=new sap.ui.model.Filter("Status","EQ",com.zespri.awct.util.Enums.DeliveryStatus.NotStarted);a.push(b);var c=new sap.ui.model.Filter("Status","EQ",com.zespri.awct.util.Enums.DeliveryStatus.InProgress);return a.push(c),a},_getDefaultSorter:function(){var a=[],b=new sap.ui.model.Sorter({path:"Status",descending:!1,group:!0}),c=new sap.ui.model.Sorter({path:"DeliveryHeaderID",descending:!1});return a.push(b),a.push(c),a},_updateListTitle:function(){var a=this._getList(),b=0;b=a.getBinding("items").iLength,this.getView().byId("masterPage").setTitle(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_MASTER_PAGE_HEADER",[b]))},_onDataLoaded:function(){var a=this._getList(),b=a.getBinding("items").getLength();if(this._updateListTitle(),0===b){var c=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_EMPTY_VIEW_TITLE");this._navToEmptyView(c," ",!0)}else this._bSelectFirstItem&&this._setFirstSelection();this._$deliveryWorkListReadDeferred.resolve()},_bindDeliveryList:function(a,b,c){var d=this._getList();this._bSelectFirstItem=!0,this._$deliveryWorkListReadDeferred=jQuery.Deferred(),this._$deliveryWorkListReadPromise=this._$deliveryWorkListReadDeferred.promise(),d.bindAggregation("items",{path:a,factory:jQuery.proxy(this._createObjectListItem,this),sorter:c,filters:b,groupHeaderFactory:jQuery.proxy(this._createGroupHeader,this)})},_createObjectListItem:function(){return sap.ui.xmlfragment("com.zespri.awct.alloc.fragment.DeliveryWorkListMasterListItemTemplate",this)},_createGroupHeader:function(a){var b="";switch(a.key){case com.zespri.awct.util.Enums.DeliveryStatus.NotStarted:b=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_SETTINGSDIALOG_NOT_STARTED_TEXT");break;case com.zespri.awct.util.Enums.DeliveryStatus.InProgress:b=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_SETTINGSDIALOG_IN_PROGRESS_TEXT");break;case com.zespri.awct.util.Enums.DeliveryStatus.Released:b=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_SETTINGSDIALOG_RELEASED_TEXT");break;case com.zespri.awct.util.Enums.DeliveryStatus.Locked:b=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_SETTINGSDIALOG_LOCKED_TEXT")}return b?new sap.m.GroupHeaderListItem({title:b,upperCase:!1}):void 0},_setFirstSelection:function(){var a=this._getList();if(!a.getSelectedItem())if(a.getBindingInfo("items").binding.isGrouped())if(a.getItems().length>1){var b=a.getItems()[1];b.firePress()}else jQuery.sap.log.error("Selection of the first list item failed as there is only one item in a grouped list");else{var c=a.getItems()[0];c.firePress()}},handleItemPress:function(a){var b=this._getList();a.getSource()!==b.getSelectedItem()&&(this._bListItemClicked=!0),this._sLastRouteIDBeforeNoResults=null,this._setSelectedListItem(a.getSource())},_setSelectedListItem:function(a){var b=this._getList();b&&b.removeSelections(!0),a.setSelected(!0),this.getRouter().navTo("Allocation/DeliveryWorkList/Detail",{contextPath:a.getBindingContext().getPath().substr(1),customData:{ItemClicked:!0}},this._bWorkListLoadedFirstTime)},handleShipmentSearch:function(){this._bSelectFirstItem=!0,this._applyFiltersAndSortersToList()},_navToEmptyView:function(a,b,c){this.getRouter().navTo("Allocation/DeliveryWorkList/NoResults",{viewTitle:a,infoText:b,isEmptyView:c})},handleViewSettingsDialogOpen:function(){this._oViewSettingsDialog.open();var a=this._oViewSettingsDialog._getPage2();a.setEnableScrolling(!1)},_initialiseViewSettingsDialog:function(a){var b=this,c,d;if(!this._oViewSettingsDialog){this._oViewSettingsDialog=sap.ui.xmlfragment("deliveryWorkListSettingsDialog","com.zespri.awct.alloc.fragment.DeliveryWorkListSettingsDialog",this),this.getView().addDependent(this._oViewSettingsDialog),this._oViewSettingsDialog._getDialog().setBusyIndicatorDelay(0),this._oViewSettingsDialog._getSubHeader().setBusyIndicatorDelay(0),this._oViewSettingsDialog._getDialog().setBusy(!0),this._oViewSettingsDialog._getSubHeader().setBusy(!0);var e=sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason,f="Season eq '"+e+"'";c=this._bindItemsToShipmentFilterList(f),d=this._bindItemsToDeliveryFilterList(""),jQuery.when(c,d).done(function(){b._oViewSettingsDialog._getDialog().setBusy(!1),b._oViewSettingsDialog._getSubHeader().setBusy(!1)})}if(a){if(a.Status){var g=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingStatus"),h=g.getItems();$.each(h,function(b,c){c.setSelected(!1),$.each(a.Status,function(a,b){var d="Status__EQ__"+b;c.getKey()===d&&c.setSelected(!0)})})}var i=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsSuppplyGTDemand"),j=i.getItems()[0];j.setSelected(void 0!==a.IsSupplyGtDemandFlag?!0:!1)}},_getCustomDataForKey:function(a,b){var c=a.getCustomData();if(c.length)for(var d=0;d<c.length;d++)if(c[d].getKey()===b)return c[d];return""},handleShipmentFilterSelect:function(a){var b=a.getSource(),c=b.getSelectedItems(),d="",e=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterShipment");if(0===c.length)this._bShipmentNumberFiltered=!1,this._bindItemsToDeliveryFilterList(""),e.setSelected(!1),e.setFilterCount(0);else{this._bShipmentNumberFiltered=!0;for(var f=0;f<c.length;f++){var g=this._getCustomDataForKey(c[f],"key"),h=g.getValue();d=d?d+" or ShipmentID eq '"+h+"'":"ShipmentID eq '"+h+"'"}e.setFilterCount(c.length),e.setSelected(!0),e.setText(com.zespri.awct.util.I18NHelper.getText("TXT_GENERIC_SHIPMENT_NUMBER")),this._bindItemsToDeliveryFilterList(d)}},handleDeliveryFilterSelect:function(a){var b=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterDelivery"),c=a.getSource(),d=c.getSelectedItems();d.length>0?(b.setFilterCount(d.length),b.setSelected(!0),b.setText(com.zespri.awct.util.I18NHelper.getText("TXT_GENERIC_DELIVERY_NUMBER"))):(b.setFilterCount(0),b.setSelected(!1))},_bindItemsToDeliveryFilterList:function(a){var b,c,d=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterDeliveryList"),e={},f=function(a){d.setModel(a),d.bindAggregation("items",{path:"/results",template:d.getBindingInfo("items")?d.getBindingInfo("items").template:d.getItems()[0].clone()}),b.resolve()},g=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),b.resolve()};return a&&(e={$filter:a}),b=$.Deferred(),c=b.promise(),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/DeliveryHeaderSet",{urlParameters:e},f,g),c},_bindItemsToShipmentFilterList:function(a){var b,c,d=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterShipmentList"),e=function(a){d.setModel(a),d.bindAggregation("items",{path:"/results",template:d.getBindingInfo("items")?d.getBindingInfo("items").template:d.getItems()[0].clone()}),b.resolve()},f=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),b.resolve()};return b=$.Deferred(),c=b.promise(),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/ShipmentSet",{urlParameters:{$filter:a}},e,f),c},handleResetViewSettingDialogFilters:function(){var a=this,b,c;this._bShipmentNumberFiltered=!1;var d=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterShipment"),e=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterShipmentList");this._oViewSettingsDialog._getDialog().setBusyIndicatorDelay(0),this._oViewSettingsDialog._getSubHeader().setBusyIndicatorDelay(0),this._oViewSettingsDialog._getDialog().setBusy(!0),this._oViewSettingsDialog._getSubHeader().setBusy(!0),e.destroyItems(),d.setFilterCount(0);var f=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterDelivery"),g=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterDeliveryList");g.destroyItems(),f.setFilterCount(0);var h=sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason,i="Season eq '"+h+"'";sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsDialogShipmentSearch").setValue(),sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsDialogDeliverySearch").setValue(),b=this._bindItemsToShipmentFilterList(i),c=this._bindItemsToDeliveryFilterList(""),jQuery.when(b,c).done(function(){a._oViewSettingsDialog._getDialog().setBusy(!1),a._oViewSettingsDialog._getSubHeader().setBusy(!1)});var j=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingStatusNotStarted");j.setSelected(!0);var k=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingStatusInProgress");k.setSelected(!0)},_createFiltersForCustomItems:function(){for(var a=[],b=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterShipmentList"),c=b.getSelectedItems(),d=0;d<c.length;d++){var e=this._getCustomDataForKey(c[d],"key"),f=e.getValue();a.push(new sap.ui.model.Filter("ShipmentID",sap.ui.model.FilterOperator.EQ,f))}for(var g=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterDeliveryList"),h=g.getSelectedItems(),i=0;i<h.length;i++){var j=this._getCustomDataForKey(h[i],"key"),k=j.getValue();a.push(new sap.ui.model.Filter("DeliveryHeaderID",sap.ui.model.FilterOperator.EQ,k))}return a},handleViewSettingsDialogClose:function(a){var b=this.byId("deliveryWorkListSearch");b.getValue()&&this._bShipmentNumberFiltered&&b.setValue("");var c=a.getParameters();this._bViewSettingsDialogChanged=!0;var d=[];jQuery.each(c.filterItems,function(a,b){if(!(b instanceof sap.m.ViewSettingsCustomItem)){var c=b.getKey().split("__"),e=c[0],f=c[1],g=c[2],h=new sap.ui.model.Filter(e,f,g);d.push(h)}});for(var e=this._createFiltersForCustomItems(),f=0;f<e.length;f++)d.push(e[f]);d.length>0?(this.byId("deliveryListFilterBar").setVisible(!0),this.byId("deliveryListFilterBarLabel").setTooltip(c.filterString),this.byId("deliveryListFilterBarLabel").setText(c.filterString)):(this.byId("deliveryListFilterBar").setVisible(!1),this._sLastRouteIDBeforeNoResults=null),this._aFiltersFromSettingsDialog=d;var g=[];if(g.push(new sap.ui.model.Sorter({path:"Status",descending:!1,group:!0})),c.sortItem){var h=c.sortItem.getKey(),i=c.sortDescending;g.push(new sap.ui.model.Sorter(h,i)),this.aSorterCopy=g}this._aSortersFromSettingsDialog=g,this._applyFiltersAndSortersToList()},_applyFiltersAndSortersToList:function(){var a=this.byId("deliveryWorkListSearch"),b=a.getValue();this._bViewSettingsDialogChanged||(this._bCustomFiltersApplied?(this._aFiltersFromSettingsDialog=this._aCustomFilters,this._aSortersFromSettingsDialog=this._getDefaultSorter()):(this._aFiltersFromSettingsDialog=this._getDefaultFilter(),this._aSortersFromSettingsDialog=this._getDefaultSorter()));var c=[];c=this._aFiltersFromSettingsDialog.slice();var d=[];if(d=this._aSortersFromSettingsDialog.slice(),b){if(!/^\d+$/.test(b))return void com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_MASTER_SEARCH_INVALID"));if(this._bShipmentNumberFiltered)return a.setValue(""),void com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_SHIPMENT_NUMBER_FILTER_ERROR"));var e=new sap.ui.model.Filter("ShipmentID",sap.ui.model.FilterOperator.Contains,b),f=new sap.ui.model.Filter([e],!0);c.push(f)}this._bindDeliveryList("/DeliveryHeaderSet",c,d)},_getListItemFromMasterList:function(a,b){for(var c=b.getItems().length,d=0;c>d;d++)if(b.getItems()[d].getBindingContext()){var e=b.getItems()[d].getBindingContext().getProperty("DeliveryHeaderID");if(a===e)return b.getItems()[d]}return null},handleviewSettingShipmentListSearch:function(a){var b=a.getParameter("query"),c=null,d=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterShipmentList");b&&b.trim().length>0&&(c=new sap.ui.model.Filter("ShipmentID",sap.ui.model.FilterOperator.Contains,b)),d.getBinding("items").filter(c)},handleviewSettingDeliveryListSearch:function(a){var b=a.getParameter("query"),c=null,d=sap.ui.core.Fragment.byId("deliveryWorkListSettingsDialog","viewSettingsFilterDeliveryList");b&&b.trim().length>0&&(c=new sap.ui.model.Filter("DeliveryHeaderID",sap.ui.model.FilterOperator.Contains,b)),d.getBinding("items").filter(c)}})}();