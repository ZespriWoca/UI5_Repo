/*----------------------------------------------------------------------* 
 * Copyright  (c) 2014 SAP SE. All rights reserved	
 * Author       : SAP Custom Development 
 *----------------------------------------------------------------------*/ 
	!function(){"use strict";jQuery.sap.require({modName:"com.zespri.awct.core.Controller",type:"controller"}),jQuery.sap.require("com.zespri.awct.util.CommonFormatHelper"),jQuery.sap.require("com.zespri.awct.util.CommonHelper"),jQuery.sap.require("com.zespri.awct.util.Enums"),jQuery.sap.require("com.zespri.awct.util.I18NHelper"),jQuery.sap.require("com.zespri.awct.util.LocaleFormatHelper"),jQuery.sap.require("com.zespri.awct.util.ModelHelper"),jQuery.sap.require("com.zespri.awct.util.NotificationHelper"),jQuery.sap.require("sap.ui.core.format.NumberFormat"),com.zespri.awct.core.Controller.extend("com.zespri.awct.alloc.view.DeliverySwapCreate",{onInit:function(){this._aChangedInputs=[],this._sDeliveryFromSelectedKey=null,this._sDeliveryToSelectedKey=null,this._sShipmentFromSelectedKey=null,this._sShipmentToSelectedKey=null,this._bIsWarning=!1,this._bIsWarningColumnAdded=!1,this._oWarningColumn=null,this._iLastScrollPosition=null,this._mSwapAllLineEntity={},this._mSwapQuantityChanges={},this._mSwapQuantityChangesInInvalidState={},this._mSwapAllLine={},this._aInvalidSwapQuantityInputs=[],this._mMandatoryFilterValuesProvided={DeliveryFrom:!1,DeliveryTo:!1},this._oViewBatchCharacteristicsDialog=null,this._bUserAuthorized=!1,this.getRouter().attachOnBeforeNavigationWithUnsavedChanges(this.handleNavigationWithUnsavedChanges,this),this._oWarningColumn=new sap.m.Column({hAlign:"Center",header:new sap.m.Label});var a=this;this.getRouter().attachRoutePatternMatched(function(b){if("Allocation/DeliverySwapCreate"===b.getParameter("name")){if(!a._bUserAuthorized)return void com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_USER_NOT_AUTHORIZED_MESSAGE_TEXT"));this._resetAllValues()}},this)},onBeforeRendering:function(){com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Display,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)?this._bUserAuthorized=!0:(this.byId("createSwapPage")&&this.byId("createSwapPage").destroy(),this._bUserAuthorized=!1)},_resetAllValues:function(){var a=this.byId("facetFilterInitiateSwap"),b=a.getLists();jQuery.each(b,function(a,b){b.setSelectedKeys()}),this.byId("facetFilterInitiateSwap").rerender(),this._resetTable();var c=this.byId("textAndBCMisMatchInfoLayout");c.setVisible(!1),this._sDeliveryFromSelectedKey=null,this._sDeliveryToSelectedKey=null,this._sShipmentFromSelectedKey=null,this._sShipmentToSelectedKey=null,this._mSwapAllLineEntity={},this._iLastScrollPosition=null,this._mSwapQuantityChanges={},this._mSwapQuantityChangesInInvalidState={},this._mSwapAllLine={},this._mMandatoryFilterValuesProvided.DeliveryFrom=!1,this._mMandatoryFilterValuesProvided.DeliveryTo=!1,this._aChangedInputs=[],this.setHasUnsavedChanges(!1)},_setViewBusy:function(a){this.getView().setBusy(a),this.byId("createSwapPage").getFooter().setBusy(a)},_stopActionIfViewDirty:function(){if(this.getHasUnsavedChanges()){var a=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_SAVE_CHANGES_FIRST_TOAST");return com.zespri.awct.util.NotificationHelper.showErrorToast(a),!0}return!1},handleViewDirtyStateChanged:function(a){a?(this.byId("createSwapButton").setEnabled(!0),this.byId("discardChangesButton").setEnabled(!0),this.byId("facetFilterInitiateSwap").setEnabled(!1)):(this.byId("createSwapButton").setEnabled(!1),this.byId("discardChangesButton").setEnabled(!1),this.byId("facetFilterInitiateSwap").setEnabled(!0))},handleNavigationWithUnsavedChanges:function(a){var b=a.getParameter("fnAllowNavigation"),c=this,d=function(){c.setHasUnsavedChanges(!1),b()},e=com.zespri.awct.util.I18NHelper.getText("TXT_GENERIC_NAVIGATION_DATA_LOSS_MESSAGE");com.zespri.awct.util.NotificationHelper.showConfirmDialog(e,d)},handleFacetFilterReset:function(){this._stopActionIfViewDirty()||this._resetAllValues()},_resetTable:function(){var a=this.byId("deliverySwapCreateTable");a.removeColumn(this._oWarningColumn),a.destroyItems(),this._bIsWarningColumnAdded=!1,a.setNoDataText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_NO_DATA_TEXT_MANDATORY"))},handleDiscardChanges:function(){jQuery.sap.assert(this.getHasUnsavedChanges(),"Cancel was clicked even though there is nothing to be saved!");var a=this,b=function(){a._mSwapAllLineEntity={},a._iLastScrollPosition=null,a._mSwapQuantityChanges={},a._mSwapQuantityChangesInInvalidState={},jQuery.each(a._aInvalidSwapQuantityInputs,function(a,b){b.setValueState(sap.ui.core.ValueState.None)}),a._aInvalidSwapQuantityInputs=[];var b=a.getView().getModel("initiateSwapLines");jQuery.each(a._aChangedInputs,function(c,d){b.setProperty("/SwapQuantity",0,d),a._updateDeliveryLine(d)}),a._aChangedInputs=[],a.setHasUnsavedChanges(!1);var c=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_CHANGES_DISCARDED_TOAST");com.zespri.awct.util.NotificationHelper.showSuccessToast(c)},c=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_CONFIRM_DISCARD_CHANGES_DIALOG");com.zespri.awct.util.NotificationHelper.showConfirmDialog(c,b)},handleSwapCreate:function(){jQuery.sap.assert(this.getHasUnsavedChanges(),"Create Swap was clicked even though there is nothing to be created!"),jQuery.sap.assert(!jQuery.isEmptyObject(this._mSwapQuantityChanges),"Create Swap was clicked even though there are no tracked quantity changes!");var a=this,b=this.getView().getModel("initiateSwapLines"),c=b.getData().results,d=[],e=this.getView().getModel();if(0!==this._aInvalidSwapQuantityInputs.length){var f=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_BEFORE_SAVE_TOAST");return void com.zespri.awct.util.NotificationHelper.showErrorToast(f)}if(jQuery.isEmptyObject(this._mSwapQuantityChanges)){var g=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_NO_CHANGES_TOAST");return void com.zespri.awct.util.NotificationHelper.showErrorToast(g)}if(!jQuery.isEmptyObject(this._mSwapAllLine)){var h=!0;if(jQuery.each(this._mSwapAllLine,function(a,b){return Number(b.NewQuantity)?void(h=!1):void 0}),!h){var i=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_ALL_IS_NOT_ZERO_TOAST");return void com.zespri.awct.util.NotificationHelper.showErrorDialog(i)}}var j=function(){a._setViewBusy(!0),jQuery.each(a._mSwapQuantityChanges,function(b,e){for(var f=e.SourceDeliveryLineID,g=0;g<c.length;g++)if(c[g].SourceDeliveryLineID===f&&!Number(c[g].SourceAllocationLineID)){var h=""!==com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c[g].SourceAllocationUpdateTime,!0)?com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c[g].SourceAllocationUpdateTime,!0):null,i=""!==com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c[g].TargetAllocationUpdateTime,!0)?com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c[g].TargetAllocationUpdateTime,!0):null,j=""!==com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c[g].TargetDeliveryLineUpdateTime,!0)?com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c[g].TargetDeliveryLineUpdateTime,!0):null,k={RecordType:com.zespri.awct.util.Enums.AllocationLineRecordType.DeliveryLine,SourceDeliveryLineID:c[g].SourceDeliveryLineID,SourceAllocationLineID:c[g].SourceAllocationLineID,SourceDeliveryLineUpdateTime:com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c[g].SourceDeliveryLineUpdateTime,!0),SourceAllocationUpdateTime:h,TargetDeliveryLineID:c[g].TargetDeliveryLineID,TargetAllocationLineID:c[g].TargetAllocationLineID,TargetDeliveryLineUpdateTime:j,TargetAllocationUpdateTime:i,SwapQuantity:parseFloat(c[g].SwapQuantity)+""},l=c[g].DeliveryAllocationID;a._mSwapAllLineEntity[l]=k}d.push(e)}),jQuery.each(a._mSwapAllLineEntity,function(a,b){d.push(b)});var b={SourceShipmentID:a._sShipmentFromSelectedKey,SourceDeliveryNumber:a._sDeliveryFromSelectedKey,TargetShipmentID:a._sShipmentToSelectedKey,TargetDeliveryNumber:a._sDeliveryToSelectedKey,DeliverySwapLineSet:d},f="/DeliverySwapSet";e.create(f,b,{success:function(){a._setViewBusy(!1),jQuery.sap.log.info("Swap : Create was successful."),a._aChangedInputs=[],a.setHasUnsavedChanges(!1),a.getRouter().navTo("Allocation/DeliverySwapListing"),window.setTimeout(function(){var a=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_SUCCESS_CREATE_TOAST");com.zespri.awct.util.NotificationHelper.showSuccessToast(a)},500)},error:function(b){a._setViewBusy(!1),com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),jQuery.sap.log.error("Swap : Create failed.")},async:!0})},k=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_CONFIRM_CREATE_SWAP_DIALOG",[a._sDeliveryFromSelectedKey,a._sDeliveryToSelectedKey]);com.zespri.awct.util.NotificationHelper.showConfirmDialog(k,j)},handleListOpen:function(a){var b=a.getSource().getKey(),c=this,d={},e=sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason;switch(b){case"Supplier":d.facetListControl=this.byId("facetFilterListSupplier"),d.entitySetName="SupplierSet",d.filterString="UserID eq '"+c.getView().getModel("currentUserDetails").getProperty("/UserID")+"'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"SourceShipmentID":d.facetListControl=this.byId("facetFilterListShipmentFrom"),d.entitySetName="ShipmentSet",d.filterString="Season eq '"+e+"'",d.selectString="ShipmentID",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"TargetShipmentID":d.facetListControl=this.byId("facetFilterListShipmentTo"),d.entitySetName="ShipmentSet",d.filterString="Season eq '"+e+"'",d.selectString="ShipmentID",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"SourceContainerID":d.facetListControl=this.byId("facetFilterListContainerID"),d.entitySetName="ContainerSet",d.selectString="ContainerID",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"Characteristic/Brand":d.facetListControl=this.byId("facetFilterListBrand"),d.entitySetName="GenericSearchSet",d.filterString="Scenario eq 'BRAND'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"Characteristic/Variety":d.facetListControl=this.byId("facetFilterListVariety"),d.entitySetName="GenericSearchSet",d.filterString="Scenario eq 'VARIETY'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"Characteristic/Pallet":d.facetListControl=this.byId("facetFilterListPallet"),d.entitySetName="GenericSearchSet",d.filterString="Scenario eq 'PALLET'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"Characteristic/Class":d.facetListControl=this.byId("facetFilterListClass"),d.entitySetName="GenericSearchSet",d.filterString="Scenario eq 'CLASS'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"Characteristic/GrowingMethod":d.facetListControl=this.byId("facetFilterListGrowingMethod"),d.entitySetName="GenericSearchSet",d.filterString="Scenario eq 'GROWINGMETHOD'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"Characteristic/Stack":d.facetListControl=this.byId("facetFilterListStack"),d.entitySetName="GenericSearchSet",d.filterString="Scenario eq 'STACK'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"Characteristic/PackStyle":d.facetListControl=this.byId("facetFilterListPackStyle"),d.entitySetName="GenericSearchSet",d.filterString="Scenario eq 'PACK_STYLE'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"Characteristic/Size":d.facetListControl=this.byId("facetFilterListSize"),d.entitySetName="GenericSearchSet",d.filterString="Scenario eq 'SIZE'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1);break;case"Characteristic/Label":d.facetListControl=this.byId("facetFilterListLabel"),d.entitySetName="GenericSearchSet",d.filterString="Scenario eq 'LABEL'",com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!1)}},handleDependentListOpen:function(a){var b=a.getSource(),c=a.getSource().getKey(),d={};switch(c){case"SourceDeliveryNumber":var e=this.byId("facetFilterListShipmentFrom").getSelectedItem();if(b.clearSearchField(),d.facetListControl=this.byId("facetFilterListDeliveryFrom"),d.entitySetName="DeliveryHeaderSet",e){var f=e.getKey();d.filterString="(Status eq 'E0002' or Status eq 'E0004') and ShipmentID eq '"+f+"'"}else d.filterString="(Status eq 'E0002' or Status eq 'E0004')";com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!0);break;case"TargetDeliveryNumber":var g=this.byId("facetFilterListShipmentTo").getSelectedItem();if(b.clearSearchField(),d.facetListControl=this.byId("facetFilterListDeliveryTo"),d.entitySetName="DeliveryHeaderSet",g){var h=g.getKey();d.filterString="(Status eq 'E0001' or Status eq 'E0002' or Status eq 'E0004') and ShipmentID eq '"+h+"'"}else d.filterString="(Status eq 'E0001' or Status eq 'E0002' or Status eq 'E0004')";com.zespri.awct.util.CommonHelper.createFacetFilterListItems(d,!0)}},_bindResultOnSuccess:function(a,b){b.setModel(a),b.bindItems({path:"/results",template:b.getBindingInfo("items")?b.getBindingInfo("items").template:b.getItems()[0].clone()})},handleFacetFilterClose:function(a){var b=a.getSource(),c=a.getSource().getKey(),d=this,e=this.byId("facetFilterInitiateSwap"),f=e.getFiltersModifiedAfterListOpen();if(f){switch(c){case"SourceShipmentID":if(this._sShipmentFromSelectedKey!==b.getSelectedItem().getKey()){this._sShipmentFromSelectedKey=b.getSelectedItem().getKey();var g=d.byId("facetFilterListDeliveryFrom");g.setSelectedKeys(),this._mMandatoryFilterValuesProvided.DeliveryFrom=!1}break;case"TargetShipmentID":if(this._sShipmentToSelectedKey!==b.getSelectedItem().getKey()){this._sShipmentToSelectedKey=b.getSelectedItem().getKey();var h=d.byId("facetFilterListDeliveryTo");h.setSelectedKeys(),this._mMandatoryFilterValuesProvided.DeliveryTo=!1}break;case"SourceDeliveryNumber":this._sDeliveryFromSelectedKey=b.getSelectedItem().getKey(),this._mMandatoryFilterValuesProvided.DeliveryFrom=!0;break;case"TargetDeliveryNumber":this._sDeliveryToSelectedKey=b.getSelectedItem().getKey(),this._mMandatoryFilterValuesProvided.DeliveryTo=!0}if(this._sDeliveryFromSelectedKey&&this._sDeliveryToSelectedKey&&this._sDeliveryFromSelectedKey===this._sDeliveryToSelectedKey){b===this.byId("facetFilterListDeliveryFrom")?(b.setSelectedKeys(),this._mMandatoryFilterValuesProvided.DeliveryFrom=!1):b===this.byId("facetFilterListDeliveryTo")&&(b.setSelectedKeys(),this._mMandatoryFilterValuesProvided.DeliveryTo=!1);var i=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_FACET_FILTER_VALIDATIONS");com.zespri.awct.util.NotificationHelper.showErrorToast(i)}if(this._mMandatoryFilterValuesProvided.DeliveryFrom&&this._mMandatoryFilterValuesProvided.DeliveryTo){var j=this.byId("deliverySwapCreateTable");j.setNoDataText(com.zespri.awct.util.I18NHelper.getText("TXT_LIST_NO_MATCHING_ITEMS_LABEL")),e.setEnabled(!1),this._bindItemsToTable()}else{this._resetTable();var k=this.byId("textAndBCMisMatchInfoLayout");k.setVisible(!1)}}},_createTableColumnListItem:function(a,b){var c;return c=b.getProperty("RecordType")===com.zespri.awct.util.Enums.AllocationLineRecordType.DeliveryLine?sap.ui.xmlfragment(a,"com.zespri.awct.alloc.fragment.DeliverySwapDeliveryLineTemplate",this).setBindingContext(b):sap.ui.xmlfragment(a,"com.zespri.awct.alloc.fragment.DeliverySwapAllocationLineTemplate",this).setBindingContext(b),this._bIsWarning||(c.removeCell(sap.ui.core.Fragment.byId(a,"warningIconCell")),sap.ui.core.Fragment.byId(a,"warningIconCell").destroy()),c},_bindItemsToTable:function(){var a=this,b=this.byId("deliverySwapCreateTable"),c=this.byId("facetFilterInitiateSwap"),d=this._createFilterString(),e=a.byId("textAndBCMisMatchInfoLayout");e.setVisible(!1);var f=function(d){a._bIsWarning=!1,d.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay),a.getView().setModel(d,"initiateSwapLines");for(var f=a.getView().getModel("initiateSwapLines"),g=f.getData().results.length,h=f.getData().results,i=0;g>i;i++)if(h[i].SourceDeliveryLineID&&!Number(h[i].SourceAllocationLineID)&&h[i].RecordType===com.zespri.awct.util.Enums.AllocationLineRecordType.DeliveryLine){(h[i].NoCharMatch||h[i].NoTextMatch)&&(a._bIsWarning=!0);var j=h[i].SourceDeliveryLineID+h[i].SourceAllocationLineID,k={OldQuantity:h[i].SwapQuantity,NewQuantity:h[i].SwapQuantity};a._mSwapAllLine[j]=k}a._bIsWarning?(a._bIsWarningColumnAdded||(b.insertColumn(a._oWarningColumn,8),a._bIsWarningColumnAdded=!0),e.setVisible(!0)):a._bIsWarningColumnAdded&&(a._bIsWarningColumnAdded=!1,b.removeColumn(a._oWarningColumn));var l={path:"initiateSwapLines>/results",factory:jQuery.proxy(a._createTableColumnListItem,a)};b.bindItems(l),b.setBusy(!1),c.setEnabled(!0)},g=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),b.setBusy(!1),e.setVisible(!1),c.setEnabled(!0)};b.setBusyIndicatorDelay(0),b.setBusy(!0),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/SwapOpportunitySet",{urlParameters:{$filter:d}},f,g)},_createFilterString:function(){var a=this.byId("facetFilterInitiateSwap"),b=a.getLists(),c="",d=!0;return $.each(b,function(a,b){if(b.getSelectedItems().length>0){var e=b.getKey();$.each(b.getSelectedItems(),function(a,b){var f=b.getKey();if(c&&!d)if(")"!==c[c.length-1]){var g=c.lastIndexOf("and")+4;-1!==c.lastIndexOf("and")?(c=c.substring(0,g)+"("+c.substring(g,c.length),c=c+" or "+e+" eq '"+f+"')"):c=c+" or "+e+" eq '"+f+"'"}else c=c.substring(0,c.length-1),c=c+" or "+e+" eq '"+f+"')";else c&&d?(c=c+" and "+e+" eq '"+f+"'",d=!1):(c=e+" eq '"+f+"'",d=!1)}),c&&(d=!0)}}),c},_updateDeliveryLine:function(a){for(var b=this.byId("deliverySwapCreateTable"),c=a.getProperty("SourceDeliveryLineID"),d=a.getModel().getData().results,e=d.length,f=null,g=null,h=0,i=this,j,k=0;e>k;k++)d[k].SourceDeliveryLineID!==c||Number(d[k].SourceAllocationLineID)||d[k].RecordType!==com.zespri.awct.util.Enums.AllocationLineRecordType.DeliveryLine||(f=k,j=d[k].SourceDeliveryLineID+d[k].SourceAllocationLineID,g=Number(this._mSwapAllLine[j].OldQuantity)),d[k].SourceDeliveryLineID===c&&Number(d[k].SourceAllocationLineID)&&(h+=Number(d[k].SwapQuantity));null!=f&&(d[f].SwapQuantity=g+Number(h),this._mSwapAllLine[j].NewQuantity=Number(d[f].SwapQuantity)),b.getBinding("items").refresh(!0),b.attachUpdateFinished(function(){if(i._iLastScrollPosition){var a=i.byId("createSwapPage").getDomRef(),b=a.getElementsByTagName("section").item();b.scrollTop=i._iLastScrollPosition}})},handleSwapQtyChange:function(a){this.setHasUnsavedChanges(!0);var b=a.getSource(),c=a.getParameter("value"),d=this.getView().getModel("initiateSwapLines"),e=a.getSource().getBindingContext(),f=this.byId("createSwapPage").getDomRef(),g=f.getElementsByTagName("section").item();if(this._iLastScrollPosition=g.scrollTop,isNaN(c))b.setValueState(sap.ui.core.ValueState.Error),b.setValueStateText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_VALIDATION_ENTER_NUMBER")),this._checkCurrentSourceExistInInvalidInputArray(b);else{if(!c||0===Number(c)){if(0!==this._aInvalidSwapQuantityInputs.length){var h=this._aInvalidSwapQuantityInputs.indexOf(b);if(h>-1){this._aInvalidSwapQuantityInputs.splice(h,1);var i=e.getPath();return this._mSwapQuantityChangesInInvalidState[i]=c,b.setValueState(sap.ui.core.ValueState.None),this._addValidInputToMapForCreate(e),void(this._aInvalidSwapQuantityInputs.length&&(this._mSwapQuantityChangesInInvalidState[i]=c))}}d.setProperty("/SwapQuantity",0,e),this._updateDeliveryLine(e);var j=e.getPath();return void(jQuery.isEmptyObject(this._mSwapQuantityChanges)||delete this._mSwapQuantityChanges[j])}if(Number(c)<0)return b.setValueState(sap.ui.core.ValueState.Error),b.setValueStateText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_VALIDATION_SWAP_QUANTITY_POSITIVE")),void this._checkCurrentSourceExistInInvalidInputArray(b);var k=parseInt(e.getProperty("SourceAllocationQuantity"),10);c>0&&k>=c?this._checkConstraintsAndUpdateJSONModelForValidInput(b,c):(this._checkCurrentSourceExistInInvalidInputArray(b),b.setValueState(sap.ui.core.ValueState.Error),b.setValueStateText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYSWAP_CREATE_VALIDATION_SWAP_QUANTITY_LOWER_THAN_NEW_QUANTITY")))}},_addValidInputToMapForCreate:function(a){var b=this,c=this.getView().getModel("initiateSwapLines");this._aInvalidSwapQuantityInputs.length||jQuery.isEmptyObject(this._mSwapQuantityChangesInInvalidState)||(jQuery.each(this._mSwapQuantityChangesInInvalidState,function(d,e){var f=new sap.ui.model.Context(b.getView().getModel("initiateSwapLines"),d);if(c.setProperty("/SwapQuantity",Number(e),f),b._updateDeliveryLine(f),b._aChangedInputs.push(f),Number(e)){var g=""!==com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(a.getProperty("SourceAllocationUpdateTime"),!0)?com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(a.getProperty("SourceAllocationUpdateTime"),!0):null,h=""!==com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(a.getProperty("TargetAllocationUpdateTime"),!0)?com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(a.getProperty("TargetAllocationUpdateTime"),!0):null,i=""!==com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(a.getProperty("TargetDeliveryLineUpdateTime"),!0)?com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(a.getProperty("TargetDeliveryLineUpdateTime"),!0):null,j={RecordType:com.zespri.awct.util.Enums.AllocationLineRecordType.SupplierOrderLine,SourceDeliveryLineID:a.getProperty("SourceDeliveryLineID"),SourceAllocationLineID:a.getProperty("SourceAllocationLineID"),SourceDeliveryLineUpdateTime:com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(a.getProperty("SourceDeliveryLineUpdateTime"),!0),SourceAllocationUpdateTime:g,TargetDeliveryLineID:a.getProperty("TargetDeliveryLineID"),TargetAllocationLineID:a.getProperty("TargetAllocationLineID"),TargetDeliveryLineUpdateTime:i,TargetAllocationUpdateTime:h,SwapQuantity:parseFloat(e)+""};b._mSwapQuantityChanges[d]=j}else delete b._mSwapQuantityChanges[d]}),this._mSwapQuantityChangesInInvalidState={})},_checkConstraintsAndUpdateJSONModelForValidInput:function(a,b){var c=a.getBindingContext(),d=this.getView().getModel("initiateSwapLines");if(0!==this._aInvalidSwapQuantityInputs.length){var e=c.getPath();this._mSwapQuantityChangesInInvalidState[e]=b,a.setValueState(sap.ui.core.ValueState.None);var f=this._aInvalidSwapQuantityInputs.indexOf(a);if(f>-1)return this._aInvalidSwapQuantityInputs.splice(f,1),void this._addValidInputToMapForCreate(c)}else{d.setProperty("/SwapQuantity",Number(b),c),this._updateDeliveryLine(c),a.setValueState(sap.ui.core.ValueState.None);var g=""!==com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getProperty("SourceAllocationUpdateTime"),!0)?com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getProperty("SourceAllocationUpdateTime"),!0):null,h=""!==com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getProperty("TargetAllocationUpdateTime"),!0)?com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getProperty("TargetAllocationUpdateTime"),!0):null,i=""!==com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getProperty("TargetDeliveryLineUpdateTime"),!0)?com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getProperty("TargetDeliveryLineUpdateTime"),!0):null,j=c.getPath(),k={RecordType:com.zespri.awct.util.Enums.AllocationLineRecordType.SupplierOrderLine,SourceDeliveryLineID:c.getProperty("SourceDeliveryLineID"),SourceAllocationLineID:c.getProperty("SourceAllocationLineID"),SourceDeliveryLineUpdateTime:com.zespri.awct.util.CommonFormatHelper.formatJSDateToEDMDateTimeString(c.getProperty("SourceDeliveryLineUpdateTime"),!0),SourceAllocationUpdateTime:g,TargetDeliveryLineID:c.getProperty("TargetDeliveryLineID"),TargetAllocationLineID:c.getProperty("TargetAllocationLineID"),TargetDeliveryLineUpdateTime:i,TargetAllocationUpdateTime:h,SwapQuantity:parseFloat(b)+""};this._mSwapQuantityChanges[j]=k,this._aChangedInputs.push(c)}},_checkCurrentSourceExistInInvalidInputArray:function(a){var b=this._aInvalidSwapQuantityInputs.length;if(a){for(var c=0;b>c;c++)if(this._aInvalidSwapQuantityInputs[c]===a)return;this._aInvalidSwapQuantityInputs.push(a)}},formatSourceNewQuantity:function(a,b){if(isNaN(a)||isNaN(b)){if(isNaN(a))return"";var c=com.zespri.awct.util.LocaleFormatHelper.formatQuantity(a);return c}var d=parseInt(a,10)-parseInt(b,10),e=com.zespri.awct.util.LocaleFormatHelper.formatQuantity(d);return e},formatTargetNewQuantity:function(a,b){if(isNaN(a)||isNaN(b)){if(isNaN(a))return"";var c=com.zespri.awct.util.LocaleFormatHelper.formatQuantity(a);return c}var d=parseInt(a,10)-parseInt(-1*b,10),e=com.zespri.awct.util.LocaleFormatHelper.formatQuantity(d);return e},handleViewSourceBatchCharacteristicsOpen:function(a){var b=a.getSource().getBindingContext().getProperty("SourceDeliveryLineID");this._openViewBatchCharacteristicsDialog(b)},handleViewTargetBatchCharacteristicsOpen:function(a){var b=a.getSource().getBindingContext().getProperty("TargetDeliveryLineID");this._openViewBatchCharacteristicsDialog(b)},_openViewBatchCharacteristicsDialog:function(a){var b=this,c=function(a){b._oViewBatchCharacteristicsDialog.setModel(a);var c=a.getData().results.length;sap.ui.core.Fragment.byId("viewBatchCharacteristicsFragment","viewBatchCharacteristicsTableHeader").setText(com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_VIEW_BATCH_CHARACTERISTICS_TABLE_TITLE",[c])),b._oViewBatchCharacteristicsDialog.setBusy(!1)},d=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),b._oViewBatchCharacteristicsDialog.setBusy(!1)};b._oViewBatchCharacteristicsDialog||(b._oViewBatchCharacteristicsDialog=new sap.ui.xmlfragment("viewBatchCharacteristicsFragment","com.zespri.awct.alloc.fragment.ViewBatchCharacteristics",this),sap.ui.core.Fragment.byId("viewBatchCharacteristicsFragment","viewBCToolBar").setVisible(!1),b.getView().addDependent(b._oViewBatchCharacteristicsDialog)),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/BatchCharacteristicsSet",{urlParameters:{$filter:"DeliveryLineID eq '"+a+"'",$expand:"BatchCharacteristicsValueSet"}},c,d),b._oViewBatchCharacteristicsDialog.setBusy(!0),b._oViewBatchCharacteristicsDialog.open()},handleViewBatchCharacteristicsOKPress:function(){this._oViewBatchCharacteristicsDialog.close()},formatViewBatchCharacteristicsValuesText:function(a){var b=function(a){return a.Value};return a.results.map(b).join(", ")},formatViewBatchCharacteristicsOptionText:function(a){return a===com.zespri.awct.util.Enums.ViewBCOperation.Exclude?com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_VIEW_BATCH_CHARACTERISTICS_EXCLUDE"):a===com.zespri.awct.util.Enums.ViewBCOperation.Include?com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_VIEW_BATCH_CHARACTERISTICS_INCLUDE"):""},formatDeliveryLineSwapQuantityState:function(a){return 0===Number(a)?sap.ui.core.ValueState.Sucess:sap.ui.core.ValueState.Error}})}();