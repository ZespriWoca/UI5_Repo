/*----------------------------------------------------------------------* 
 * Copyright  (c) 2014 SAP SE. All rights reserved	
 * Author       : SAP Custom Development 
 *----------------------------------------------------------------------*/ 
	!function(){"use strict";jQuery.sap.require("com.zespri.awct.util.Enums"),jQuery.sap.declare("com.zespri.awct.util.LocaleFormatHelper"),jQuery.sap.require({modName:"com.zespri.awct.core.Controller",type:"controller"}),jQuery.sap.require("com.zespri.awct.control.FileUploaderParameter"),jQuery.sap.require("com.zespri.awct.util.NotificationHelper"),com.zespri.awct.core.Controller.extend("com.zespri.awct.alloc.view.DetailDeliveryWorkList",{onInit:function(){this._oUploadDialog=null,this._bUserAuthorized=!1;var a=this.getView(),b=this;this.getRouter().attachRoutePatternMatched(function(c){"Allocation/DeliveryWorkList/Detail"===c.getParameter("name")&&b._bUserAuthorized&&(b._oContext=new sap.ui.model.Context(a.getModel(),"/"+c.getParameter("arguments").contextPath),c.getParameter("arguments").customData?c.getParameter("arguments").customData.ItemClicked&&(a.setBindingContext(b._oContext),b._updateFooterBar()):a.getModel().attachRequestCompleted(b._updateFooterOnRequestCompletion,b))},this)},onBeforeRendering:function(){com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Display,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)?this._bUserAuthorized=!0:(this.byId("detailWorkListPage")&&this.byId("detailWorkListPage").destroy(),this._bUserAuthorized=!1)},_updateFooterOnRequestCompletion:function(a){var b=a.mParameters.url;if(-1!==b.indexOf("/DeliveryHeaderSet")){if(!this._oContext.getProperty("DeliveryHeaderID"))return;this.getView().setBindingContext(this._oContext),this._updateFooterBar(),this.getView().getModel().detachRequestCompleted(this._updateFooterOnRequestCompletion,this)}},_updateFooterBar:function(){if(this._oContext.oModel){var a=this.getView().byId("uploadButton");a.setVisible(!1),com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Maintain,com.zespri.awct.util.Enums.AuthorizationObject.Allocation,com.zespri.awct.util.Enums.AuthorizationFunctions.ZESP)&&(this._oContext.getProperty("Status")!==com.zespri.awct.util.Enums.DeliveryStatus.NotStarted&&this._oContext.getProperty("Status")!==com.zespri.awct.util.Enums.DeliveryStatus.InProgress||!jQuery.device.is.desktop||a.setVisible(!0))}},handleUploadDialogOpen:function(){var a=this.getView().getBindingContext();this._oUploadDialog||(this._oUploadDialog=new sap.ui.xmlfragment("fileUploadDialog","com.zespri.awct.alloc.fragment.DeliveryWorkListUploadDialog",this),this.getView().addDependent(this._oUploadDialog));var b=sap.ui.core.Fragment.byId("fileUploadDialog","inProgressUploadInfoLayout");b.setVisible("E0002"===a.getProperty("Status")?!0:!1);var c=sap.ui.core.Fragment.byId("fileUploadDialog","fileUploader"),d=new com.zespri.awct.control.FileUploaderParameter({name:"slug",value:this.getView().getBindingContext().getProperty("DeliveryHeaderID")});c.removeAllHeaderParameters(),c.addHeaderParameter(d),c.setFileType(["csv"]),this._allowStartUpload(!1),c.setValue("").setValueState(sap.ui.core.ValueState.None),this._oUploadDialog.open()},handleUploadPress:function(){this._oUploadDialog.setBusy(!0);var a=sap.ui.core.Fragment.byId("fileUploadDialog","fileUploader");a.upload()},handleFileUploaderTypeMissmatch:function(){this._allowStartUpload(!1)},handleFileUploaderFileAllowed:function(){this._allowStartUpload(!0)},handleFileUploaderUploadComplete:function(a){var b=a.getParameters().status||"",c=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_DETAIL_UPLOAD_SUCCESS_TOAST"),d=com.zespri.awct.util.I18NHelper.getText("TXT_ALLOCATION_DELIVERYWORKLIST_DETAIL_UPLOAD_ERROR_TOAST");if(com.zespri.awct.util.Constants.C_IS_BROWSER_IE&&sap.ui.Device.browser.version<=9){var e=a.getParameters().response,f={};try{f=JSON.parse(e),200===parseInt(f.status,10)?(com.zespri.awct.util.NotificationHelper.showSuccessToast(c),this._navToEditOrderAllocation()):($.each(f.result,function(a,b){"E"===b.type&&(d+=" ("+b.message+")")}),com.zespri.awct.util.NotificationHelper.showErrorDialog(d))}catch(g){com.zespri.awct.util.NotificationHelper.showErrorDialog(d)}}else if(jQuery.sap.startsWith(b.toString(),"2"))com.zespri.awct.util.NotificationHelper.showSuccessToast(c),this._navToEditOrderAllocation();else{var h=a.getParameters().responseRaw,i=$.parseXML(h).getElementsByTagName("message")[0];d+=" ("+i.textContent+")",com.zespri.awct.util.NotificationHelper.showErrorDialog(d)}this._oUploadDialog.setBusy(!1)},handleUploadCancel:function(){var a=sap.ui.core.Fragment.byId("fileUploadDialog","fileUploader");a.abort(),this._oUploadDialog.setBusy(!1),this._oUploadDialog.close()},_allowStartUpload:function(a){var b=sap.ui.core.Fragment.byId("fileUploadDialog","fileUploader"),c=sap.ui.core.Fragment.byId("fileUploadDialog","startUploadButton");a?(b.setValueState(sap.ui.core.ValueState.None),c.setEnabled(!0)):(b.setValueState(sap.ui.core.ValueState.Error),c.setEnabled(!1))},handleNavToEditAllocation:function(){this._navToEditOrderAllocation()},_navToEditOrderAllocation:function(){var a=this.getView().getBindingContext();this.getRouter().navTo("Allocation/EditOrderAllocation",{contextPath:a.getPath().substr(1)})}})}();