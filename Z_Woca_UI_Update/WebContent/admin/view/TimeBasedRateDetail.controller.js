/*----------------------------------------------------------------------* 
 * Copyright  (c) 2014 SAP SE. All rights reserved	
 * Author       : SAP Custom Development 
 *----------------------------------------------------------------------*/ 
	!function(){"use strict";jQuery.sap.require({modName:"com.zespri.awct.core.Controller",type:"controller"}),jQuery.sap.require("com.zespri.awct.util.Constants"),jQuery.sap.require("com.zespri.awct.util.CommonFormatHelper"),jQuery.sap.require("com.zespri.awct.util.Enums"),jQuery.sap.require("com.zespri.awct.util.I18NHelper"),jQuery.sap.require("com.zespri.awct.util.LocaleFormatHelper"),jQuery.sap.require("com.zespri.awct.util.ModelHelper"),jQuery.sap.require("com.zespri.awct.util.NotificationHelper"),com.zespri.awct.core.Controller.extend("com.zespri.awct.admin.view.TimeBasedRateDetail",{onInit:function(){this._sViewStatus=null,this._oTimeRateContext=null,this._bUserAuthorized=!1;var a=this;this.getRouter().attachRoutePatternMatched(function(b){if("Administration/TimeRateDetail"===b.getParameter("name")){if(a._bUserAuthorized){var c=b.getParameter("arguments").contextPath;this._sViewStatus=b.getParameter("arguments").viewMode,a.byId("saveTimeRateButton").setEnabled(!1),a._initializeView(c)}else com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_USER_NOT_AUTHORIZED_MESSAGE_TEXT"));a.getRouter().attachOnBeforeNavigationWithUnsavedChanges(this.handleNavigationWithUnsavedChanges,this)}else a.getRouter().detachOnBeforeNavigationWithUnsavedChanges(this.handleNavigationWithUnsavedChanges,this)},this)},onBeforeRendering:function(){com.zespri.awct.util.CommonHelper.isUserAuthorized(com.zespri.awct.util.Enums.AuthorizationMode.Display,com.zespri.awct.util.Enums.AuthorizationObject.Administration,com.zespri.awct.util.Enums.AuthorizationFunctions.ZADM)?this._bUserAuthorized=!0:(this.byId("pageTimeRateDetail")&&this.byId("pageTimeRateDetail").destroy(),this._bUserAuthorized=!1)},_disableForm:function(){this.byId("selectVariety").setEnabled(!1),this.byId("selectClass").setEnabled(!1),this.byId("selectGrowingMethod").setEnabled(!1),this.byId("selectPackStyle").setEnabled(!1),this.byId("selectCountry").setEnabled(!1),this.byId("selectShipmentType").setEnabled(!1),this.byId("selectChargeCode").setEnabled(!1),this.byId("selectSchedule").setEnabled(!1),this.byId("selectPriority").setEnabled(!1),this.byId("selectSize").setEnabled(!1),this.byId("selectActiveFlag").setEnabled(!1),this.byId("switchShortNotice").setState(!1);var a=this.byId("dateValidFrom"),b=this.byId("dateValidTo");a.setEnabled(!1),b.setEnabled(!1),a.addStyleClass("zAwctDisabledDatepicker"),b.addStyleClass("zAwctDisabledDatepicker")},_clearForm:function(){var a=this.byId("selectVariety"),b=this.byId("selectClass"),c=this.byId("selectGrowingMethod"),d=this.byId("selectPackStyle"),e=this.byId("selectCountry"),f=this.byId("selectShipmentType"),g=this.byId("selectChargeCode"),h=this.byId("selectSchedule"),i=this.byId("dateValidFrom"),j=this.byId("dateValidTo"),k=this.byId("selectPriority"),l=this.byId("selectSize"),m=this.byId("selectActiveFlag"),n=this.byId("switchShortNotice");a.setSelectedKey(""),b.setSelectedKey(""),c.setSelectedKey(""),d.setSelectedKey(""),e.setSelectedKey(""),f.setSelectedKey(""),g.setSelectedKey(""),h.setSelectedKey(""),i.setValue(""),j.setValue(""),k.setSelectedKey("10"),l.setSelectedKey(""),m.setState(!0),n.setState(!1)},_setSelectedItem:function(a,b){var c=this._oTimeRateContext.getProperty(b),d=this.byId(a);d.setSelectedKey(c)},_setDateFields:function(a,b){var c=this._oTimeRateContext.getProperty(b),d=this.byId(a);d.setValue(c)},setFormData:function(){var a=this,b={selectVariety:"Characteristic/Variety",selectClass:"Characteristic/Class",selectGrowingMethod:"Characteristic/GrowingMethod",selectCountry:"Country",selectPackStyle:"Characteristic/PackStyle",selectSize:"Characteristic/Size",selectShipmentType:"ShipmentType",selectChargeCode:"ChargeCode",selectSchedule:"ScheduleName",selectPriority:"Priority"},c={dateValidFrom:"ValidFrom",dateValidTo:"ValidTo"};$.each(b,function(b,c){a._setSelectedItem(b,c)}),$.each(c,function(b,c){a._setDateFields(b,c)});var d=this._oTimeRateContext.getProperty("Active");this.byId("selectActiveFlag").setState(d);var e=this._oTimeRateContext.getProperty("ShortNoticeFlag");this.byId("switchShortNotice").setState(e)},_getContextPath:function(){var a=this.getView().getModel(),b=this._oTimeRateContext.getPath().substr(1);if(this._oTimeRateContext.getModel()!==a){var c=this._oTimeRateContext.getModel().getData().result,d=c.__metadata.uri,e=d.split("/");e.length&&(b=e[e.length-1])}return b},handleSavePress:function(){var a=this,b=this.getView().getModel(),c=function(){var b=com.zespri.awct.util.I18NHelper.getText("TXT_ADMIN_TIME_RATES_SAVE_SUCCESS");com.zespri.awct.util.NotificationHelper.showSuccessToast(b),a.setHasUnsavedChanges(!1),a.byId("saveTimeRateButton").setEnabled(!1),a.getView().setBusy(!1),a.getRouter().navTo("Administration/TimeBasedRateMaintenance",{customData:{noTableRefresh:!0}})},d=function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a.getView().setBusy(!1)},e=this.byId("selectChargeCode"),f=this.byId("selectSchedule"),g=this.byId("selectPriority"),h=this.byId("dateValidFrom"),i=this.byId("dateValidTo");if(e.getSelectedItem().getKey()&&f.getSelectedItem().getKey()&&g.getSelectedItem().getKey()&&h.getValue()&&i.getValue())if(new Date(h.getValue())>new Date(i.getValue()))com.zespri.awct.util.NotificationHelper.showErrorDialog(com.zespri.awct.util.I18NHelper.getText("TXT_ADMIN_TIME_RATES_DETAILS_FROMDATE_GREATER_THAN_TODATE_ERROR_MESSAGE"));else{var j=this.getFormData();if(this.getView().setBusy(!0),this._sViewStatus===com.zespri.awct.util.Enums.ViewMode.Add)b.create("/TimeBasedRateSet",j,{success:c,error:d,async:!0});else{var k=this._getContextPath();b.update(k,j,{success:c,error:d,merge:!0})}}else com.zespri.awct.util.NotificationHelper.showErrorDialog(com.zespri.awct.util.I18NHelper.getText("TXT_ADMIN_TIME_RATES_DETAILS_MANDATORY_FIELDS_ERROR_MESSAGE"))},handleDeletePress:function(){var a=this,b=this._getContextPath(),c=com.zespri.awct.util.I18NHelper.getText("TXT_ADMIN_TIME_RATES_CONFIRM_DELETE"),d=function(){var b=com.zespri.awct.util.I18NHelper.getText("TXT_ADMIN_TIME_RATES_DELETE_SUCCESS");com.zespri.awct.util.NotificationHelper.showSuccessToast(b),a.setHasUnsavedChanges(!1),a.getView().setBusy(!1),a.getRouter().navBack()},e=function(b){com.zespri.awct.util.NotificationHelper.handleErrorMessage(b),a.getView().setBusy(!1)},f=function(){var c=a.getView().getModel();a.getView().setBusy(!0),c.remove(b,{success:d,error:e})};com.zespri.awct.util.NotificationHelper.showConfirmDialog(c,f)},getFormData:function(){var a=this.byId("selectVariety"),b=this.byId("selectClass"),c=this.byId("selectGrowingMethod"),d=this.byId("selectPackStyle"),e=this.byId("selectSize"),f=this.byId("selectCountry"),g=this.byId("selectShipmentType"),h=this.byId("selectChargeCode"),i=this.byId("selectSchedule"),j=this.byId("dateValidFrom"),k=this.byId("dateValidTo"),l=this.byId("selectPriority"),m=this.byId("selectActiveFlag"),n=this.byId("switchShortNotice"),o={Characteristic:{}};return o.Characteristic.Variety=a.getSelectedItem().getKey(),o.Characteristic.Class=b.getSelectedItem().getKey(),o.Characteristic.GrowingMethod=c.getSelectedItem().getKey(),o.Characteristic.PackStyle=d.getSelectedItem().getKey(),o.Characteristic.Size=e.getSelectedItem().getKey(),o.Country=f.getSelectedItem().getKey(),o.ShipmentType=g.getSelectedItem().getKey(),o.ChargeCode=h.getSelectedItem().getKey(),o.ScheduleName=i.getSelectedItem().getKey(),o.Active=m.getState(),j.getValue()&&(o.ValidFrom=this._getExternalFormatValue(j)),k.getValue()&&(o.ValidTo=this._getExternalFormatValue(k)),o.Priority=parseInt(l.getSelectedItem().getKey(),10),o.ShortNoticeFlag=n.getState(),o.Season=sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason,o},handleCancelPress:function(){this.getRouter().navBack()},handleNavigationWithUnsavedChanges:function(a){var b=a.getParameter("fnAllowNavigation"),c=this,d=function(){c.setHasUnsavedChanges(!1),b()},e=com.zespri.awct.util.I18NHelper.getText("TXT_GENERIC_NAVIGATION_DATA_LOSS_MESSAGE");com.zespri.awct.util.NotificationHelper.showConfirmDialog(e,d)},handleInputChange:function(){this.setHasUnsavedChanges(!0),this.byId("saveTimeRateButton").setEnabled(!0)},_initializeView:function(a){var b=this,c=$.Deferred(),d=c.promise();this.getView().setBusy(!0);var e=function(a,d,e){var f=d.data.__batchResponses,g=new sap.ui.model.json.JSONModel;g.setSizeLimit(com.zespri.awct.util.Constants.C_ODATA_MODEL_SIZE_LIMIT);var h={Key:"",Value:""};f[0].data.results.unshift(h),f[1].data.results.unshift(h),f[2].data.results.unshift(h),f[3].data.results.unshift(h),f[4].data.results.unshift(h),f[5].data.results.unshift({ShipmentTypeID:""}),f[6].data.results.unshift(h),f[7].data.results.unshift({CountryCode:""}),f[8].data.results.unshift(h),g.setProperty("/Varieties",f[0].data.results),g.setProperty("/Classes",f[1].data.results),g.setProperty("/GrowingMethods",f[2].data.results),g.setProperty("/PackStyles",f[3].data.results),g.setProperty("/Sizes",f[4].data.results),g.setProperty("/ShipmentTypes",f[5].data.results),g.setProperty("/Schedules",f[6].data.results),g.setProperty("/Countries",f[7].data.results),g.setProperty("/ChargeCodes",f[8].data.results),b.getView().setModel(g,"domainValues"),com.zespri.awct.util.NotificationHelper.handleErrorMessage(e),c.resolve()},f=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a)},g=this.getView().getModel(),h=sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason,i=g.createBatchOperation("GenericSearchSet?$filter=Scenario%20eq%20%27VARIETY%27","GET"),j=g.createBatchOperation("GenericSearchSet?$filter=Scenario%20eq%20%27CLASS%27","GET"),k=g.createBatchOperation("GenericSearchSet?$filter=Scenario%20eq%20%27GROWING_METHOD%27","GET"),l=g.createBatchOperation("GenericSearchSet?$filter=Scenario%20eq%20%27PACK_STYLE%27","GET"),m=g.createBatchOperation("GenericSearchSet?$filter=Scenario%20eq%20%27SIZE%27","GET"),n=g.createBatchOperation("GetShipmentTypesForDifotis?Season=%27"+h+"%27","GET"),o=g.createBatchOperation("ScheduleSet","GET"),p=g.createBatchOperation("GetCountriesForSeason?Season=%27"+h+"%27","GET"),q=g.createBatchOperation("GenericSearchSet?$filter=Scenario%20eq%20%27CHARGECODE%27","GET"),r=[i,j,k,l,m,n,o,p,q];g.addBatchReadOperations(r),g.submitBatch(e,f);var s=$.Deferred(),t=s.promise();if(this.getView().byId("pageTimeRateDetail").setTitle(com.zespri.awct.util.I18NHelper.getText("TXT_ADMIN_TIME_RATES_DETAIL_PAGE_TITLE_ADD")),this._sViewStatus===com.zespri.awct.util.Enums.ViewMode.Add)b._clearForm(),b.byId("deleteTimeRateButton").setVisible(!1),s.resolve();else{this.getView().byId("pageTimeRateDetail").setTitle(com.zespri.awct.util.I18NHelper.getText("TXT_ADMIN_TIME_RATES_DETAIL_PAGE_TITLE")),b.byId("deleteTimeRateButton").setVisible(!0),b._oTimeRateContext=new sap.ui.model.Context(b.getView().getModel(),"/"+a);var u=b._oTimeRateContext.getProperty("TimeBasedRateID");if(u)b.setFormData(),s.resolve();else{var v=function(a){b._oTimeRateContext=new sap.ui.model.Context(a,"/result"),b.setFormData(),s.resolve()},w=function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a)};com.zespri.awct.util.ModelHelper.getJSONModelForRead(a,{},v,w)}}$.when(d,t).done(function(){b.getView().setBusy(!1)})},_getExternalFormatValue:function(a){var b=a.getYyyymmdd(),c=b.substring(0,4),d=b.substring(4,6),e=b.substring(6,8),f=c+"-"+d+"-"+e+"T00:00:00";return f},formatSelectItems:function(a,b){return a||b?a+" - "+b:""}})}();