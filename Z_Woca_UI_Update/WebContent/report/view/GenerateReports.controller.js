/*----------------------------------------------------------------------* 
 * Copyright  (c) 2014 SAP SE. All rights reserved	
 * Author       : SAP Custom Development 
 *----------------------------------------------------------------------*/ 
	!function(){"use strict";jQuery.sap.require({modName:"com.zespri.awct.core.Controller",type:"controller"}),jQuery.sap.require("com.zespri.awct.util.CommonFormatHelper"),jQuery.sap.require("com.zespri.awct.util.CommonHelper"),jQuery.sap.require("com.zespri.awct.util.LocaleFormatHelper"),jQuery.sap.require("com.zespri.awct.util.ModelHelper"),jQuery.sap.require("com.zespri.awct.util.NotificationHelper"),com.zespri.awct.core.Controller.extend("com.zespri.awct.report.view.GenerateReports",{_FileType:{CSV:"CSV"},_BusinessAction:{DOWNLOAD:"Download"},onInit:function(){this._oSearchHelpDialog=null,this._bUserAuthorized=!1,this._aSearchInputIDs=["seasonInput","shipmentNumberInput","deliveryNumberInput","loadPortInput","supplierInput","shipmentNameInput","shipmentTypeInput","planRegInput","destinationCountryInput","destinationPortInput","coolStoreInput","containerIDInput","brandInput","varietyInput","classInput","growingMethodInput","palletInput","stackInput","packStyleInput","sizeInput","labelInput"],this._oBusyDialog=new sap.m.BusyDialog;var a=this;this.getRouter().attachRoutePatternMatched(function(b){return"Reports/GenerateReports"!==b.getParameter("name")||a._bUserAuthorized?void 0:void com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_USER_NOT_AUTHORIZED_MESSAGE_TEXT"))}),this._setCurrentSeasonSelected(),this._setViewBusy(!0),com.zespri.awct.util.ModelHelper.getJSONModelForRead("/GenericSearchSet",{urlParameters:{$filter:"Scenario eq 'Report'"}},function(b){a._setViewBusy(!1);var c=a.byId("reportTypeSelect");c.setModel(b),c.bindItems({path:"/results",template:c.getBindingInfo("items")?c.getBindingInfo("items").template:c.getItems()[0].clone()})},function(b){a._setViewBusy(!1),com.zespri.awct.util.NotificationHelper.handleErrorMessage(b)})},onBeforeRendering:function(){com.zespri.awct.util.CommonHelper.isUserAuthorized(null,com.zespri.awct.util.Enums.AuthorizationObject.Reports,null)?this._bUserAuthorized=!0:(this.byId("generateReportsPage")&&this.byId("generateReportsPage").destroy(),this._bUserAuthorized=!1)},onAfterRendering:function(){$(".hasDatepicker").focus(function(a){var b=$("#"+a.currentTarget.id).css("width"),c=parseInt(b,10),d=c-350;$(".ui-datepicker").css("margin-left",d.toString()+"px")})},_getCustomDataForKey:function(a,b){var c=a.getCustomData();if(c.length)for(var d=0;d<c.length;d++)if(c[d].getKey()===b)return c[d];return""},bindTableSelectDialog:function(a){var b=this.getView(),c=this,d=c._getCustomDataForKey(a,"entitySet").getValue(),e=c._getCustomDataForKey(a,"BindingKey").getValue(),f="",g="";c._getCustomDataForKey(a,"filter")&&(f=c._getCustomDataForKey(a,"filter").getValue());var h=function(b){c._oSearchHelpDialog.setGrowingThreshold(b.getData().results.length),c._oSearchHelpDialog.setModel(b);var d={path:"/results",factory:function(a,b){var c=b.getProperty(e);return new sap.m.ColumnListItem({cells:[new sap.m.Text({text:c})]})}};c._oSearchHelpDialog.bindItems(d);for(var f=a.getValue().split(", "),g=0;g<f.length;g++)for(var h=0;h<c._oSearchHelpDialog.getItems().length;h++)f[g]&&f[g]===c._oSearchHelpDialog.getItems()[h].getCells()[0].getText()&&c._oSearchHelpDialog.getItems()[h].setSelected(!0);c._oSearchHelpDialog._dialog.setBusy(!1)};this._oSearchHelpDialog.destroyItems(),this._oSearchHelpDialog._dialog.setBusy(!0),this._oSearchHelpDialog._dialog.setBusyIndicatorDelay(0);var i=c._getCustomDataForKey(a,"filterButtonKey").getValue();switch(i){case"ShipmentID":var j=b.byId("seasonInput"),k="";c._getCustomDataForKey(j,"filterValue")&&(k=c._getCustomDataForKey(j,"filterValue").getValue());var l="Season eq '"+sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason+"'";k&&(l="Season eq '"+k+"'"),com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$select:e,$filter:l}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()});break;case"DestinationCountry":case"ShipmentType":case"ShipName":var m=b.byId("seasonInput"),n="";c._getCustomDataForKey(m,"filterValue")&&(n=c._getCustomDataForKey(m,"filterValue").getValue()),n||(n=sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason),com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{Season:"'"+n+"'"}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()});break;case"DeliveryNumber":case"ContainerID":var o=b.byId("shipmentNumberInput"),p="",q=[],r=[];c._getCustomDataForKey(o,"filterValue")&&(r=c._getCustomDataForKey(o,"filterValue").getValue()),jQuery.each(r,function(a,b){q.push("ShipmentID eq '"+b+"'")}),p=q.join(" or "),com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$select:e,$filter:p}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()});break;case"Supplier":com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$filter:"UserID eq '"+c.getView().getModel("currentUserDetails").getProperty("/UserID")+"'"}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()});break;default:if(g="",f){var s=JSON.parse(f);g=s.path+" "+s.operator+" '"+s.value1+"'"}com.zespri.awct.util.ModelHelper.getJSONModelForRead(d,{urlParameters:{$filter:g}},h,function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),c._oSearchHelpDialog._dialog.setBusy(!1),c._oSearchHelpDialog._dialog.close()})}},handleValueHelpPress:function(a){this._oSearchInputField=a.getSource(),this._oSearchHelpDialog||(this._oSearchHelpDialog=new sap.ui.xmlfragment("ReportsSearchFormDialog","com.zespri.awct.report.fragment.SearchFieldSelectionDialog",this),this.getView().addDependent(this._oSearchHelpDialog));var b=this._getCustomDataForKey(this._oSearchInputField,"label").getValue();this._oSearchHelpDialog.setTitle(b),sap.ui.core.Fragment.byId("ReportsSearchFormDialog","searchFieldLabel").setText(com.zespri.awct.util.I18NHelper.getText("TXT_REPORTS_GENERATE_FORM_VALUE_HELP_DIALOG_ALL_LABEL")),this._oSearchInputField.getId()===this.createId("seasonInput")?(this._oSearchHelpDialog.setMultiSelect(!1),sap.ui.core.Fragment.byId("ReportsSearchFormDialog","searchFieldLabel").setVisible(!1)):(this._oSearchHelpDialog.setMultiSelect(!0),sap.ui.core.Fragment.byId("ReportsSearchFormDialog","searchFieldLabel").setVisible(!0)),this.bindTableSelectDialog(this._oSearchInputField),com.zespri.awct.util.CommonHelper.manageNoDataText(this._oSearchHelpDialog._table),this._oSearchHelpDialog.open()},handleValueHelpDialogSearch:function(a){var b=a.getParameter("value"),c=this.getView().getController()._getCustomDataForKey(this._oSearchInputField,"filterKey").getValue(),d=new sap.ui.model.Filter(c,sap.ui.model.FilterOperator.Contains,b),e=a.getSource().getBinding("items");e.filter([d])},handleValueHelpDialogOKPress:function(a){var b=this._getCustomDataForKey(this._oSearchInputField,"filterKey").getValue(),c=this._getCustomDataForKey(this._oSearchInputField,"BindingKey").getValue(),d=a.getParameter("selectedContexts"),e=d.map(function(a){return a.getProperty(b)}),f=d.map(function(a){return a.getProperty(c)});this._oSearchInputField.setValue(f.join(", ")),this._getCustomDataForKey(this._oSearchInputField,"filterValue")&&this._oSearchInputField.removeCustomData(this._getCustomDataForKey(this._oSearchInputField,"filterValue")),e.length>0&&this._oSearchInputField.addCustomData(new sap.ui.core.CustomData({key:"filterValue",value:e})),this._getCustomDataForKey(this.byId("seasonInput"),"filterValue")||this._setCurrentSeasonSelected();var g=this.getView().byId("shipmentNumberInput"),h=this.getView().byId("deliveryNumberInput"),i=this.getView().byId("containerIDInput");this._oSearchInputField.getId()===this.createId("seasonInput")&&(g.setValue(""),this._getCustomDataForKey(g,"filterValue")&&g.removeCustomData(this._getCustomDataForKey(g,"filterValue"))),this._oSearchInputField.getId()===this.createId("shipmentNumberInput")&&(h.setValue(""),this._getCustomDataForKey(h,"filterValue")&&h.removeCustomData(this._getCustomDataForKey(h,"filterValue")),i.setValue(""),this._getCustomDataForKey(i,"filterValue")&&i.removeCustomData(this._getCustomDataForKey(i,"filterValue")))},handleDownLoadPress:function(){jQuery.device.is.desktop?(this.byId("downloadAsCSVButton").focus(),window.setTimeout(this._trigerDownload.bind(this),0)):this._trigerDownload()},_trigerDownload:function(){var a=[],b=0,c=this.getView().byId("fromDateInput"),d=this.getView().byId("toDateInput"),e=this.getView().byId("cLoadFromDateInput"),f=this.getView().byId("cLoadDateInput"),g=!1;for(c.setValueState(sap.ui.core.ValueState.None),d.setValueState(sap.ui.core.ValueState.None),e.setValueState(sap.ui.core.ValueState.None),f.setValueState(sap.ui.core.ValueState.None);b<this._aSearchInputIDs.length;){var h=this.getView().byId(this._aSearchInputIDs[b]),i=[],j="";if(this._getCustomDataForKey(h,"filterButtonKey")&&(j=this._getCustomDataForKey(h,"filterButtonKey").getValue()),this._getCustomDataForKey(h,"filterValue")){var k=this._getCustomDataForKey(h,"filterValue").getValue();for(var l in k){var m=j+" eq '"+k[l]+"'";i.push(m)}var n="("+i.join(" or ")+")";a.push(n)}b+=1}if(c.getValue()){var o="("+this._getCustomDataForKey(c,"filterButtonKey").getValue()+" eq "+this._getExternalFormatValue(c.getYyyymmdd())+")";a.push(o)}if(d.getValue()){var p="("+this._getCustomDataForKey(d,"filterButtonKey").getValue()+" eq "+this._getExternalFormatValue(d.getYyyymmdd())+")";a.push(p)}if(c.getValue()&&d.getValue()&&new Date(c.getValue())>new Date(d.getValue())&&(c.setValueState(sap.ui.core.ValueState.Error),d.setValueState(sap.ui.core.ValueState.Error),g=!0),e.getValue()){var q="("+this._getCustomDataForKey(e,"filterButtonKey").getValue()+" eq "+this._getExternalFormatValue(e.getYyyymmdd())+")";a.push(q)}if(f.getValue()){var r="("+this._getCustomDataForKey(f,"filterButtonKey").getValue()+" eq "+this._getExternalFormatValue(f.getYyyymmdd())+")";a.push(r)}if(e.getValue()&&f.getValue()&&new Date(e.getValue())>new Date(f.getValue())&&(e.setValueState(sap.ui.core.ValueState.Error),f.setValueState(sap.ui.core.ValueState.Error),g=!0),g)com.zespri.awct.util.NotificationHelper.showErrorToast(com.zespri.awct.util.I18NHelper.getText("TXT_REPORTS_GENERATE_FORM_DOWNLOAD_ERROR_TOAST_MESSAGE"));else{var s=this.byId("reportTypeSelect").getSelectedKey();a.push("(ReportCode eq '"+s+"')");var t=a.join(" and "),u=this.getView().getModel();u.setHeaders({BusinessAction:this._BusinessAction.DOWNLOAD,FileType:this._FileType.CSV}),this._oBusyDialog.open();var v=this;com.zespri.awct.util.ModelHelper.getJSONModelForRead("/ReportSet",{urlParameters:{$filter:t}},function(a){u.setHeaders(null),v._oBusyDialog.close();var b=a.getData().results[0].FileGuid;return 0!==parseInt(b,10)||isNaN(b)?(com.zespri.awct.util.NotificationHelper.showSuccessToast(com.zespri.awct.util.I18NHelper.getText("TXT_REPORTS_GENERATE_FORM_STARTING_DOWNLOAD_TOAST_MESSAGE")),void(window.location.href=window.location.protocol+"//"+window.location.host+"/sap/opu/odata/sap/Z_AWCT_SRV/FileDownloadSet('"+b+"')/$value")):void com.zespri.awct.util.NotificationHelper.showSuccessToast(com.zespri.awct.util.I18NHelper.getText("TXT_GENERIC_DOWNLOAD_NO_MATCHING_RESULTS_FOUND_MESSAGE"))},function(a){com.zespri.awct.util.NotificationHelper.handleErrorMessage(a),u.setHeaders(null),v._oBusyDialog.close()})}},_setCurrentSeasonSelected:function(){var a=this.byId("seasonInput"),b=sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason;a.setValue(b),a.addCustomData(new sap.ui.core.CustomData({key:"filterValue",value:[b]}))},_getExternalFormatValue:function(a){var b=a.substring(0,4),c=a.substring(4,6),d=a.substring(6,8);return"datetime'"+b+"-"+c+"-"+d+"T00:00:00'"},handleResetPress:function(){var a=this.getView();jQuery.each(this._aSearchInputIDs,function(b,c){var d=a.byId(c);d.setValue(""),a.getController()._getCustomDataForKey(d,"filterValue")&&d.removeCustomData(a.getController()._getCustomDataForKey(d,"filterValue"))});var b=this.byId("seasonInput"),c=sap.ui.getCore().getRootComponent().getApplicationParameters().CurrentSeason;b.setValue(c),b.addCustomData(new sap.ui.core.CustomData({key:"filterValue",value:[c]})),this.byId("fromDateInput").setValue(""),this.byId("toDateInput").setValue(""),this.byId("cLoadFromDateInput").setValue(""),this.byId("cLoadDateInput").setValue()},_setViewBusy:function(a){this.getView().setBusy(a),this.byId("generateReportsPage").getFooter().setBusy(a)}})}();